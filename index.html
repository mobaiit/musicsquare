<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>墨白音乐盒</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- 预加载所有需要的图标 -->
    <div style="display:none;">
        <i data-lucide="search"></i><i data-lucide="play"></i><i data-lucide="pause"></i><i data-lucide="skip-forward"></i><i data-lucide="skip-back"></i><i data-lucide="heart"></i><i data-lucide="more-horizontal"></i><i data-lucide="chevron-down"></i><i data-lucide="repeat"></i><i data-lucide="repeat-1"></i><i data-lucide="shuffle"></i><i data-lucide="download"></i><i data-lucide="type"></i><i data-lucide="volume-2"></i><i data-lucide="volume-x"></i><i data-lucide="list"></i><i data-lucide="arrow-left"></i><i data-lucide="palette"></i><i data-lucide="music"></i><i data-lucide="loader-2"></i>
    </div>
    <style>
        :root{
            --bg:linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --panel:rgba(0,0,0,0.3);
            --accent:#ff6b6b;
            --text-main:#ffffff;
            --text-sub:rgba(255,255,255,0.7);
            --border:rgba(255,255,255,0.1);
            --glass:rgba(0,0,0,0.2);
        }
        #app.alt-style{
            --bg:linear-gradient(135deg, #1a1a1f 0%, #1e1e24 50%, #222228 100%);
            --accent:#1db954;
        }
        #app.alt-style-1{
            --bg:linear-gradient(135deg, #1f1a2e 0%, #1a2e2a 50%, #1e2e1f 100%);
            --accent:#ff6b35;
        }
        #app.alt-style-2{
            --bg:linear-gradient(135deg, #2a2a3a 0%, #2e2a3e 50%, #3a2a3e 100%);
            --accent:#ff1744;
        }
        #app.alt-style-3{
            --bg:linear-gradient(135deg, #1a2a3a 0%, #1a2e3a 50%, #1e3a2a 100%);
            --accent:#00d4ff;
        }
        #app.alt-style-4{
            --bg:linear-gradient(135deg, #3a2a2e 0%, #3e2e1a 50%, #3a2e2a 100%);
            --accent:#ffeb3b;
        }
        #app.alt-style-5{
            --bg:linear-gradient(135deg, #2a3a3a 0%, #2e3a3e 50%, #3a3e3a 100%);
            --accent:#ffd700;
        }
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text-main);font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB",Microsoft YaHei,sans-serif;overflow:hidden;transition:background 0.3s ease;}
        body.alt-style{background:linear-gradient(135deg, #1a1a1f 0%, #1e1e24 50%, #222228 100%);}
        body.alt-style-1{background:linear-gradient(135deg, #1f1a2e 0%, #1a2e2a 50%, #1e2e1f 100%);}
        body.alt-style-2{background:linear-gradient(135deg, #2a2a3a 0%, #2e2a3e 50%, #3a2a3e 100%);}
        body.alt-style-3{background:linear-gradient(135deg, #1a2a3a 0%, #1a2e3a 50%, #1e3a2a 100%);}
        body.alt-style-4{background:linear-gradient(135deg, #3a2a2e 0%, #3e2e1a 50%, #3a2e2a 100%);}
        body.alt-style-5{background:linear-gradient(135deg, #2a3a3a 0%, #2e3a3e 50%, #3a3e3a 100%);}
        #app{display:flex;flex-direction:column;height:100%;max-width:540px;margin:0 auto;background:transparent;backdrop-filter:blur(20px);border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,0.3);}

        /* 顶部导航 */
        .topbar{flex-shrink:0;height:40px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--panel);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);border-radius:20px 20px 0 0;}
        .topbar .logo{font-size:18px;font-weight:700;letter-spacing:.5px;color:var(--accent);text-shadow:0 0 10px rgba(255,107,107,0.5);}
        .topbar .author{font-size:12px;color:var(--text-sub);}

        /* 版权声明 */
        .copyright{flex-shrink:0;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);font-size:11px;color:var(--text-sub);text-align:center;display:flex;align-items:center;justify-content:center;gap:8px;}
        .disclaimer-btn{padding:4px 8px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.1);color:var(--text-sub);font-size:10px;cursor:pointer;}

        /* 免责声明弹窗 */
        .disclaimer-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center;}
        .disclaimer-content{background:var(--panel);border-radius:16px;padding:20px;margin:20px;max-width:400px;backdrop-filter:blur(20px);border:1px solid var(--border);}
        .disclaimer-title{font-size:16px;font-weight:600;color:var(--accent);margin-bottom:16px;text-align:center;}
        .disclaimer-text{font-size:13px;line-height:1.6;color:var(--text-main);margin-bottom:16px;}
        .disclaimer-close{width:100%;padding:8px;border:none;border-radius:8px;background:var(--accent);color:#000;font-size:14px;cursor:pointer;}

        /* 搜索栏 */
        .searchbar{flex-shrink:0;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);}
        .searchbar .search{position:relative;}
        .searchbar .search input{width:100%;height:32px;border-radius:20px;border:none;background:rgba(255,255,255,.15);color:var(--text-main);padding:0 32px 0 12px;font-size:14px;outline:none;backdrop-filter:blur(10px);}
        .searchbar .search .icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text-sub);cursor:pointer;}
        .searchbar .search .loading{position:absolute;right:36px;top:50%;transform:translateY(-50%);width:14px;height:14px;border:2px solid transparent;border-top:2px solid var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:none;}
        @keyframes spin{to{transform:translateY(-50%) rotate(360deg);}}
        .animate-spin{animation:spin-icon 1s linear infinite;}
        @keyframes spin-icon{to{transform:rotate(360deg);}}

        /* 搜索历史 */
        .search-history{flex-shrink:0;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);display:none;}
        .search-history.show{display:block;}
        .search-history-btn{margin:4px 8px 4px 0;padding:4px 12px;border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.1);color:var(--text-main);font-size:12px;cursor:pointer;}

        /* 来源选择条 */
        .sourcebar{flex-shrink:0;display:flex;gap:8px;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);font-size:12px;color:var(--text-sub);justify-content:space-between;align-items:center;}
        .sourcebar .sources{display:flex;gap:8px;}
        .sourcebar label{display:flex;align-items:center;gap:4px;}
        .sourcebar input{margin:0;width:12px;height:12px;accent-color:var(--accent);}

        /* 设置选项条 */
        .settingsbar{flex-shrink:0;display:flex;gap:16px;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);font-size:12px;color:var(--text-sub);justify-content:center;align-items:center;}
        .settingsbar .limit-wrapper{display:flex;align-items:center;gap:6px;}
        .settingsbar .quality-wrapper{display:flex;align-items:center;gap:6px;}
        .settingsbar select{background:#000;color:var(--text-main);border:1px solid var(--border);border-radius:8px;padding:3px 6px;font-size:11px;outline:none;}
        .sourcebar select option[value="standard"]{color:#4caf50;}
        .sourcebar select option[value="high"]{color:#4dd0e1;}
        .sourcebar select option[value="lossless"]{color:#ffb74d;}

        /* 中间内容区 */
        .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
        .tabs{flex-shrink:0;display:flex;justify-content:space-around;padding:8px 0;border-bottom:1px solid var(--border);}
        .tabs .tab{padding:6px 14px;font-size:14px;color:var(--text-sub);position:relative;}
        .tabs .tab.active{color:var(--accent);}
        .tabs .tab.active::after{content:"";position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:20px;height:3px;background:var(--accent);border-radius:2px;}
        .scroll{flex:1;overflow-y:auto;padding:12px 16px;}
        .scroll::-webkit-scrollbar{width:0;}

        /* 歌曲列表项 */
        .track{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);}
        .track .index{width:28px;text-align:center;font-size:12px;color:var(--text-sub);}
        .track .cover{width:48px;height:48px;border-radius:6px;margin-right:12px;background:rgba(255,255,255,.08);object-fit:cover;}
        .track .info{flex:1;min-width:0;}
        .track .title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .track .artist{font-size:12px;color:var(--text-sub);margin-top:2px;display:flex;align-items:center;gap:4px;}
        .track .source-tag{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,.1);}
        .track .source-migu{color:#ffb74d;}
        .track .source-netease{color:#ff6b6b;}
        .track .source-qq{color:#4dd0e1;}
        .track .source-kuwo{color:#ba68c8;}
        .track .playbtn{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:16px;display:flex;align-items:center;justify-content:center;margin-left:8px;}
        .track.playing .playbtn{background:#fff;color:var(--accent);}

        /* 底部播放器 - 简化版 */
        .player{flex-shrink:0;height:64px;background:var(--panel);border-top:1px solid var(--border);display:none;align-items:center;padding:8px 16px;position:relative;backdrop-filter:blur(30px);border-radius:0 0 20px 20px;}
        .player.show{display:flex;}
        .player .cover-wrapper{position:relative;margin-right:12px;}
        .player .cover{width:48px;height:48px;border-radius:12px;background:rgba(255,255,255,.1);object-fit:cover;box-shadow:0 4px 16px rgba(0,0,0,.2);}
        .player .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3);border-radius:12px;opacity:0;transition:opacity .2s;cursor:pointer;}
        .player .play-overlay:hover{opacity:1;}
        .player .play-overlay button{width:24px;height:24px;border-radius:50%;border:none;background:var(--accent);color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(255,107,107,0.4);}
        .player .info{flex:1;min-width:0;margin-right:12px;}
        .player .title{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;}
        .player .artist{font-size:12px;color:var(--text-sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:4px;}
        .player .quality-tag{font-size:10px;padding:1px 4px;border-radius:3px;background:rgba(0,0,0,.5);}
        .player .quality-standard{color:#4caf50;}
        .player .quality-high{color:#4dd0e1;}
        .player .quality-lossless{color:#ffb74d;}
        .player .controls{display:flex;align-items:center;gap:8px;}
        .player .controls button{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,255,255,.1);color:var(--text-main);font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
        .player .controls button:active{transform:scale(0.95);}
        .player .menu-btn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.1);color:var(--text-sub);font-size:16px;margin-left:8px;border:none;display:flex;align-items:center;justify-content:center;}

        /* 进度条 */
        .progress{position:absolute;left:0;right:0;top:0;height:3px;background:rgba(255,255,255,.1);cursor:pointer;}
        .progress .bar{height:100%;background:linear-gradient(90deg,var(--accent),#ff6b6b);transform-origin:left;transform:scaleX(0);border-radius:0 2px 2px 0;will-change:transform;}
        .progress .handle{position:absolute;top:50%;width:12px;height:12px;background:var(--accent);border-radius:50%;box-shadow:0 2px 6px rgba(255,205,50,.5);opacity:0;transition:opacity .2s;transform:translateY(-50%) translateX(-50%);will-change:transform;}
        .progress:hover .handle{opacity:1;}

        /* 全屏播放器面板 */
        .full-player-panel{
            position:fixed;
            inset:0;
            background:linear-gradient(135deg,rgba(26,26,46,0.5),rgba(26,31,58,0.5));
            display:flex;
            flex-direction:column;
            transform:translateY(100%);
            transition:transform .4s cubic-bezier(.4,0,.2,1);
            z-index:102;
        }
        .full-player-panel.show{
            transform:translateY(0);
        }
        .full-player-opacity-control{
            position:absolute;
            top:20px;
            right:20px;
            display:flex;
            align-items:center;
            gap:8px;
            z-index:104;
        }
        .lyrics-view.show ~ .full-player-opacity-control,
        .playlist-view[style*="flex"] ~ .full-player-opacity-control{
            display:none;
        }
        .full-opacity-slider{
            width:80px;
            height:4px;
            background:rgba(255,255,255,.2);
            border-radius:2px;
            outline:none;
            -webkit-appearance:none;
        }
        .full-opacity-slider::-webkit-slider-thumb{
            width:12px;
            height:12px;
            background:var(--accent);
            border-radius:50%;
            -webkit-appearance:none;
            cursor:pointer;
        }
        .full-player-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 20px;
            height:56px;
        }
        .close-btn{
            width:40px;
            height:40px;
            border-radius:50%;
            background:rgba(255,255,255,.1);
            border:none;
            color:var(--text-main);
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .full-player-song-info{
            text-align:center;
            padding:0 24px;
            margin-bottom:16px;
        }
        .full-player-song-info .full-title{
            font-size:18px;
            font-weight:600;
            margin-bottom:6px;
        }
        .full-player-song-info .full-artist{
            font-size:14px;
            color:var(--text-sub);
            display:flex;
            align-items:center;
            justify-content:center;
            gap:6px;
        }
        .full-quality-tag{
            font-size:11px;
            padding:2px 6px;
            border-radius:4px;
            background:rgba(0,0,0,.6);
        }
        .full-quality-standard{color:#4caf50;}
        .full-quality-high{color:#4dd0e1;}
        .full-quality-lossless{color:#ffb74d;}
        .full-player-cover{
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:40px;
        }

        @media (min-width: 768px) {
            .full-player-cover {
                justify-content: center;
                gap: 64px;
            }
            .cover-lyrics-container {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 20px;
                width: 100%;
                max-width: none;
            }
            .cover-container {
                flex: 0 0 30%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            .lyrics-container {
                flex: 0 0 30%;
                max-height: 400px;
                overflow-y: auto;
                padding: 30px 20px;
                background: transparent;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .lyrics-container::-webkit-scrollbar {
                width: 0;
            }
            .full-player-song-info {
                display: none;
            }
            .pc-song-info {
                text-align: center;
                margin-top: 20px;
                display: block;
            }
            .pc-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 6px;
            }
            .pc-artist {
                font-size: 14px;
                color: var(--text-sub);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }
            .inline-lyrics {
                text-align: center;
                font-size: 20px;
                line-height: 2.5;
                color: #ffffff;
                width: 100%;
            }
            .inline-lyrics div {
                transition: all .35s cubic-bezier(.4,0,.2,1);
                margin: 8px 0;
                cursor:pointer;
                padding:4px 8px;
                border-radius:8px;
            }
            .inline-lyrics div:hover {
                background:rgba(255,255,255,.05);
            }
            .inline-lyrics .active {
                color: var(--accent);
                font-size: 26px;
                font-weight: 700;
                text-shadow: 0 0 15px rgba(255,205,50,.55);
                transform: scale(1.05);
            }
        }
        .rotating-cover{
            width:280px;
            height:280px;
            border-radius:50%;
            object-fit:cover;
            background:rgba(255,255,255,.1);
            animation:rotate 20s linear infinite;
            box-shadow:0 8px 32px rgba(0,0,0,.4);
        }
        .rotating-cover.paused{
            animation-play-state:paused;
        }
        @keyframes rotate{
            from{transform:rotate(0deg);}
            to{transform:rotate(360deg);}
        }
        .full-player-progress{
            display:flex;
            align-items:center;
            padding:0 24px;
            margin-bottom:32px;
        }
        .time{
            font-size:12px;
            color:var(--text-sub);
            width:40px;
            text-align:center;
        }
        .full-progress{
            flex:1;
            height:4px;
            background:rgba(255,255,255,.2);
            border-radius:2px;
            margin:0 12px;
            position:relative;
            cursor:pointer;
        }
        .full-bar{
            height:100%;
            background:linear-gradient(90deg,var(--accent),#ff6b6b);
            border-radius:2px;
            transform-origin:left;
            transform:scaleX(0);
        }
        .full-handle{
            position:absolute;
            top:50%;
            transform:translateY(-50%);
            width:16px;
            height:16px;
            background:var(--accent);
            border-radius:50%;
            left:0;
            box-shadow:0 2px 8px rgba(255,205,50,.6);
        }
        .full-player-controls{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:24px;
            padding:0 24px;
            margin-bottom:24px;
        }
        .control-btn{
            width:56px;
            height:56px;
            border-radius:50%;
            border:none;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:24px;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .2s;
        }
        .control-btn:active{
            transform:scale(0.95);
        }
        .play-btn{
            width:72px;
            height:72px;
            background:var(--accent);
            color:#000;
            font-size:32px;
            box-shadow:0 4px 16px rgba(255,205,50,.4);
        }
        .full-player-actions{
            display:flex;
            align-items:center;
            justify-content:space-around;
            padding:0 40px 24px;
        }
        .action-btn{
            width:48px;
            height:48px;
            border-radius:50%;
            border:none;
            background:rgba(255,255,255,.08);
            color:var(--text-sub);
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .lyrics-play-btn{
            position:fixed;
            bottom:30px;
            right:30px;
            width:56px;
            height:56px;
            border-radius:50%;
            border:none;
            background:var(--accent);
            color:#000;
            font-size:24px;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 4px 16px rgba(255,107,107,0.4);
            z-index:105;
        }

        /* 播放列表视图 */
        .playlist-view{
            position:absolute;
            inset:0;
            background:rgba(26,26,46,0.9);
            display:flex;
            flex-direction:column;
            z-index:103;
            backdrop-filter:blur(10px);
        }
        .playlist-controls{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 20px;
            border-bottom:1px solid var(--border);
        }
        .playlist-mode-btn{
            width:40px;
            height:40px;
            border-radius:50%;
            border:none;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:16px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .playlist-batch-controls{
            display:none;
            align-items:center;
            gap:8px;
        }
        .playlist-batch-controls.show{
            display:flex;
        }
        .batch-btn{
            padding:6px 12px;
            border:1px solid var(--border);
            border-radius:16px;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:12px;
            cursor:pointer;
        }
        .playlist-opacity-control{
            position:absolute;
            top:70px;
            right:20px;
            display:none;
            align-items:center;
            gap:8px;
            z-index:104;
        }
        .opacity-slider{
            width:80px;
            height:4px;
            background:rgba(255,255,255,.2);
            border-radius:2px;
            outline:none;
            -webkit-appearance:none;
        }
        .opacity-slider::-webkit-slider-thumb{
            width:12px;
            height:12px;
            background:var(--accent);
            border-radius:50%;
            -webkit-appearance:none;
            cursor:pointer;
        }
        .playlist-scroll{
            flex:1;
            overflow-y:auto;
            padding:0;
        }
        .playlist-item{
            display:flex;
            align-items:center;
            padding:12px 20px;
            border-bottom:1px solid var(--border);
            cursor:pointer;
        }
        .playlist-item:hover{
            background:rgba(255,255,255,.05);
        }
        .playlist-item.active{
            background:rgba(255,107,107,.1);
        }
        .playlist-item .checkbox{
            width:20px;
            height:20px;
            margin-right:12px;
            accent-color:var(--accent);
            display:none;
        }
        .playlist-item.batch-mode .checkbox{
            display:block;
        }
        .playlist-item .index{
            width:24px;
            font-size:12px;
            color:var(--text-sub);
        }
        .playlist-item.batch-mode .index{
            display:none;
        }
        .playlist-item .info{
            flex:1;
            margin-left:12px;
        }
        .playlist-item .title{
            font-size:14px;
            margin-bottom:2px;
        }
        .playlist-item .artist{
            font-size:12px;
            color:var(--text-sub);
        }


        /* 歌词视图 */
        .lyrics-view{
            position:absolute;
            inset:0;
            background:var(--bg);
            display:flex;
            flex-direction:column;
            z-index:103;
            transform:translateX(100%);
            transition:transform .3s cubic-bezier(.4,0,.2,1);
        }
        .lyrics-view.show{
            transform:translateX(0);
        }
        .lyrics-scroll-full{
            flex:1;
            overflow-y:auto;
            padding:20px;
            text-align:center;
            font-size:18px;
            line-height:2.5;
            color:#ffffff;
        }
        .lyrics-scroll-full::-webkit-scrollbar {
            width: 6px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .lyrics-scroll-full:hover::-webkit-scrollbar {
            opacity: 1;
        }
        .lyrics-scroll-full::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        .lyrics-scroll-full::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        .lyrics-scroll-full::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        .lyrics-scroll-full div{
            transition:all .35s cubic-bezier(.4,0,.2,1);
            margin:8px 0;
            cursor:pointer;
            padding:4px 8px;
            border-radius:8px;
        }
        .lyrics-scroll-full div:hover{
            background:rgba(255,255,255,.05);
        }
        .lyrics-scroll-full .active{
            color:var(--accent);
            font-size:22px;
            font-weight:700;
            text-shadow:0 0 15px rgba(255,205,50,.55);
            transform:scale(1.02);
        }
        .lyrics-scroll-full.alt-style{
            color:var(--text-sub);
            font-size:22px;
            font-weight:700;
            text-shadow:0 0 15px rgba(255,205,50,.55);
            transform:scale(1.02);
        }
        .lyrics-scroll-full.alt-style .active{
            color:#ff69b4;
            text-shadow:0 0 20px rgba(255,105,180,.8);
        }
        .lyrics-view.alt-style{
            background:linear-gradient(135deg,rgba(16,16,20,.95),rgba(32,32,40,.95));
        }
        .lyrics-view.alt-style .lyrics-scroll-full{
            color:#e0e0e0;
        }
        .lyrics-view.alt-style .lyrics-scroll-full .active{
            color:#1db954;
            text-shadow:0 0 20px rgba(29,185,84,.6);
        }
        .lyrics-view.alt-style-1{
            background:linear-gradient(135deg,rgba(20,20,30,.95),rgba(40,40,60,.95));
        }
        .lyrics-view.alt-style-1 .lyrics-scroll-full{
            color:#f0f0f0;
        }
        .lyrics-view.alt-style-1 .lyrics-scroll-full .active{
            color:#ff6b35;
            text-shadow:0 0 20px rgba(255,107,53,.6);
        }
        .lyrics-view.alt-style-2{
            background:linear-gradient(135deg,rgba(25,25,35,.95),rgba(45,45,65,.95));
        }
        .lyrics-view.alt-style-2 .lyrics-scroll-full{
            color:#ffffff;
        }
        .lyrics-view.alt-style-2 .lyrics-scroll-full .active{
            color:#ff1744;
            text-shadow:0 0 20px rgba(255,23,68,.6);
        }
        .lyrics-view.alt-style-3{
            background:linear-gradient(135deg,rgba(18,18,25,.95),rgba(35,35,50,.95));
        }
        .lyrics-view.alt-style-3 .lyrics-scroll-full{
            color:#f5f5f5;
        }
        .lyrics-view.alt-style-3 .lyrics-scroll-full .active{
            color:#00d4ff;
            text-shadow:0 0 20px rgba(0,212,255,.6);
        }
        .lyrics-view.alt-style-4{
            background:linear-gradient(135deg,rgba(200,50,50,.7),rgba(150,30,30,.7));
        }
        .lyrics-view.alt-style-4 .lyrics-scroll-full{
            color:#ffffff;
        }
        .lyrics-view.alt-style-4 .lyrics-scroll-full .active{
            color:#ffeb3b;
            text-shadow:0 0 20px rgba(255,235,59,.8);
        }
        .lyrics-view.alt-style-5{
            background:linear-gradient(135deg,rgba(30,144,255,.7),rgba(0,191,255,.7));
        }
        .lyrics-view.alt-style-5 .lyrics-scroll-full{
            color:#ffffff;
        }
        .lyrics-view.alt-style-5 .lyrics-scroll-full .active{
            color:#ffd700;
            text-shadow:0 0 20px rgba(255,215,0,.8);
        }
        .cover-lyrics-container.alt-style{
            background:linear-gradient(135deg,rgba(16,16,20,.95),rgba(32,32,40,.95));
        }
        .cover-lyrics-container.alt-style .inline-lyrics{
            color:#e0e0e0;
        }
        .cover-lyrics-container.alt-style .inline-lyrics .active{
            color:#1db954;
            text-shadow:0 0 20px rgba(29,185,84,.6);
        }
        .cover-lyrics-container.alt-style-1{
            background:linear-gradient(135deg,rgba(20,20,30,.95),rgba(40,40,60,.95));
        }
        .cover-lyrics-container.alt-style-1 .inline-lyrics{
            color:#f0f0f0;
        }
        .cover-lyrics-container.alt-style-1 .inline-lyrics .active{
            color:#ff6b35;
            text-shadow:0 0 20px rgba(255,107,53,.6);
        }
        .cover-lyrics-container.alt-style-2{
            background:linear-gradient(135deg,rgba(25,25,35,.95),rgba(45,45,65,.95));
        }
        .cover-lyrics-container.alt-style-2 .inline-lyrics{
            color:#ffffff;
        }
        .cover-lyrics-container.alt-style-2 .inline-lyrics .active{
            color:#ff1744;
            text-shadow:0 0 20px rgba(255,23,68,.6);
        }
        .cover-lyrics-container.alt-style-3{
            background:linear-gradient(135deg,rgba(18,18,25,.95),rgba(35,35,50,.95));
        }
        .cover-lyrics-container.alt-style-3 .inline-lyrics{
            color:#f5f5f5;
        }
        .cover-lyrics-container.alt-style-3 .inline-lyrics .active{
            color:#00d4ff;
            text-shadow:0 0 20px rgba(0,212,255,.6);
        }
        .cover-lyrics-container.alt-style-4{
            background:linear-gradient(135deg,rgba(200,50,50,.95),rgba(150,30,30,.95));
        }
        .cover-lyrics-container.alt-style-4 .inline-lyrics{
            color:#ffffff;
        }
        .cover-lyrics-container.alt-style-4 .inline-lyrics .active{
            color:#ffeb3b;
            text-shadow:0 0 20px rgba(255,235,59,.8);
        }
        .cover-lyrics-container.alt-style-5{
            background:linear-gradient(135deg,rgba(30,144,255,.95),rgba(0,191,255,.95));
        }
        .cover-lyrics-container.alt-style-5 .inline-lyrics{
            color:#ffffff;
        }
        .full-player-panel.alt-style{
            background:linear-gradient(135deg,rgba(16,16,20,.95),rgba(32,32,40,.95));
        }
        .full-player-panel.alt-style .inline-lyrics{
            color:#e0e0e0;
        }
        .full-player-panel.alt-style .inline-lyrics .active{
            color:#1db954;
            text-shadow:0 0 20px rgba(29,185,84,.6);
        }
        .full-player-panel.alt-style-1{
            background:linear-gradient(135deg,rgba(20,20,30,.95),rgba(40,40,60,.95));
        }
        .full-player-panel.alt-style-1 .inline-lyrics{
            color:#f0f0f0;
        }
        .full-player-panel.alt-style-1 .inline-lyrics .active{
            color:#ff6b35;
            text-shadow:0 0 20px rgba(255,107,53,.6);
        }
        .full-player-panel.alt-style-2{
            background:linear-gradient(135deg,rgba(25,25,35,.95),rgba(45,45,65,.95));
        }
        .full-player-panel.alt-style-2 .inline-lyrics{
            color:#ffffff;
        }
        .full-player-panel.alt-style-2 .inline-lyrics .active{
            color:#ff1744;
            text-shadow:0 0 20px rgba(255,23,68,.6);
        }
        .full-player-panel.alt-style-3{
            background:linear-gradient(135deg,rgba(18,18,25,.95),rgba(35,35,50,.95));
        }
        .full-player-panel.alt-style-3 .inline-lyrics{
            color:#f5f5f5;
        }
        .full-player-panel.alt-style-3 .inline-lyrics .active{
            color:#00d4ff;
            text-shadow:0 0 20px rgba(0,212,255,.6);
        }
        .full-player-panel.alt-style-4{
            background:linear-gradient(135deg,rgba(200,50,50,.7),rgba(150,30,30,.7));
        }
        .full-player-panel.alt-style-4 .inline-lyrics{
            color:#ffffff;
        }
        .full-player-panel.alt-style-4 .inline-lyrics .active{
            color:#ffeb3b;
            text-shadow:0 0 20px rgba(255,235,59,.8);
        }
        .full-player-panel.alt-style-5{
            background:linear-gradient(135deg,rgba(30,144,255,.7),rgba(0,191,255,.7));
        }
        .full-player-panel.alt-style-5 .inline-lyrics{
            color:#ffffff;
        }
        .full-player-panel.alt-style-5 .inline-lyrics .active{
            color:#ffd700;
            text-shadow:0 0 20px rgba(255,215,0,.8);
        }
        .lyrics-controls{
            display:flex;
            justify-content:center;
            gap:16px;
            padding:16px 24px 24px;
        }
        .lyrics-btn{
            padding:8px 16px;
            border:1px solid var(--border);
            border-radius:20px;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:14px;
        }

        /* 音量控制面板 */
        .volume-panel{
            position:absolute;
            inset:0;
            background:var(--bg);
            display:flex;
            flex-direction:column;
            z-index:103;
        }
        .volume-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 20px;
            height:56px;
        }
        .volume-title{
            font-size:16px;
            font-weight:600;
        }
        .volume-content{
            flex:1;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:40px;
        }
        .volume-display{
            font-size:48px;
            font-weight:700;
            color:var(--accent);
            margin-bottom:40px;
        }
        .volume-slider-full{
            width:80%;
            height:6px;
            background:rgba(255,255,255,.2);
            border-radius:3px;
            outline:none;
            -webkit-appearance:none;
            margin-bottom:40px;
        }
        .volume-slider-full::-webkit-slider-thumb{
            width:24px;
            height:24px;
            background:var(--accent);
            border-radius:50%;
            -webkit-appearance:none;
            cursor:pointer;
            box-shadow:0 2px 8px rgba(255,205,50,.4);
        }
        .volume-buttons{
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            justify-content:center;
        }
        .volume-btn,.volume-preset{
            padding:8px 16px;
            border:1px solid var(--border);
            border-radius:20px;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:14px;
        }

        /* PC端歌曲信息 */
        .pc-song-info {
            display: none;
        }
        @media (min-width: 768px) {
            .pc-song-info {
                display: block;
                text-align: center;
                margin-top: 20px;
            }
            .pc-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 6px;
            }
            .pc-artist {
                font-size: 14px;
                color: var(--text-sub);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }
        }
        .lyrics-mask{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.55);
            z-index:100;
            display:none;
            opacity:0;
            transition:opacity .3s cubic-bezier(.4,0,.2,1);
        }
        .lyrics-mask.show{
            display:block;
            opacity:1;
        }

        /* 图标固定尺寸，防止变化时影响布局 */
        svg[data-lucide], i[data-lucide] {
            width: 1em !important;
            height: 1em !important;
            flex-shrink: 0 !important;
            display: inline-block !important;
            transition: none !important;
        }

        /* 防止图标渲染时闪烁 */
        .player, .searchbar {
            will-change: auto;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* 图标容器稳定性 */
        .player .controls button,
        .searchbar .icon {
            min-width: 32px;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- 顶部 -->
    <header class="topbar">
        <div class="logo">墨白音乐盒</div>
        <div class="author">QQ: 37010871</div>
    </header>

    <!-- 版权声明 -->
    <div class="copyright">
        <span>本站仅作为学习演示，音乐版权归各平台与原作者所有。</span>
        <button class="disclaimer-btn" id="disclaimerOpenBtn">免责声明</button>
    </div>

    <!-- 来源选择 -->
    <div class="sourcebar">
        <div class="sources">
            <label><input type="checkbox" data-src="migu">咪咕</label>
            <label><input type="checkbox" data-src="netease" checked>网易云</label>
            <label><input type="checkbox" data-src="qq">QQ</label>
            <label><input type="checkbox" data-src="kuwo">酷我</label>
        </div>
    </div>

    <!-- 设置选项 -->
    <div class="settingsbar">
        <div class="limit-wrapper">
            <span>数量:</span>
            <select id="limitSelect">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="30">30</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
        <div class="quality-wrapper">
            <span>音质:</span>
            <select id="qualitySelect">
                <option value="standard">标准</option>
                <option value="high" selected>高品质</option>
                <option value="lossless">无损</option>
            </select>
        </div>
        <button class="disclaimer-btn" id="disclaimerBtn" style="margin-left:auto;">风格切换</button>
    </div>

    <!-- 搜索栏 -->
    <div class="searchbar">
        <div class="search">
            <input id="searchInput" placeholder="搜索音乐、歌手">
            <span class="loading" id="loading"></span>
            <i data-lucide="search" class="icon" id="searchIcon"></i>
        </div>
    </div>

    <!-- 搜索历史 -->
    <div id="searchHistory" class="search-history"></div>

    <!-- 中间 -->
    <main class="main">
        <nav class="tabs">
            <div class="tab active" data-tab="results">搜索</div>
            <div class="tab" data-tab="favorites">收藏</div>
            <div class="tab" data-tab="playlists">历史</div>
        </nav>
        <div id="scroll" class="scroll"></div>
    </main>

    <!-- 底部播放器 - 简化版 -->
    <footer class="player" id="player">
        <div id="progressWrapper" class="progress">
            <div id="progressBar" class="bar"></div>
            <div id="progressHandle" class="handle"></div>
        </div>
        <div class="cover-wrapper">
            <img id="cover" class="cover" style="display:none">
            <div id="coverPlaceholder" class="cover-placeholder" style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,rgba(255,205,50,.15),rgba(255,183,77,.15));display:flex;align-items:center;justify-content:center;color:var(--accent);font-size:22px;box-shadow:0 2px 6px rgba(255,205,50,.2);"><i data-lucide="music"></i></div>
        </div>
        <div class="info">
            <div id="title" class="title">暂未选择歌曲</div>
            <div id="artist" class="artist">点击选择音乐</div>
        </div>
        <div class="controls">
            <button id="playPauseBtn"><i data-lucide="play"></i></button>
            <button id="nextBtn"><i data-lucide="skip-forward"></i></button>
            <button id="favBtn"><i data-lucide="heart"></i></button>
        </div>
        <button id="menuBtn" class="menu-btn"><i data-lucide="more-horizontal"></i></button>
    </footer>
</div>

<!-- 全屏播放器面板 -->
<div id="fullPlayerMask" class="lyrics-mask"></div>
<div id="fullPlayerPanel" class="full-player-panel">
    <div class="full-player-opacity-control">
        <span style="font-size:12px;color:var(--text-sub);">透明度</span>
        <input id="fullPlayerOpacitySlider" class="full-opacity-slider" type="range" min="0.3" max="1" step="0.1" value="0.5">
    </div>
    <div class="full-player-header">
        <button id="fullPlayerClose" class="close-btn"><i data-lucide="chevron-down"></i></button>
        <div style="width:40px;"></div>
        <div style="width:40px;"></div>
    </div>
    <div class="full-player-cover">
        <div class="cover-lyrics-container">
            <div class="cover-container">
                <img id="fullCover" class="rotating-cover" src="">
                <div class="full-cover-placeholder" style="width:280px;height:280px;border-radius:50%;background:linear-gradient(135deg,rgba(255,205,50,.15),rgba(255,183,77,.15));display:block;text-align:center;line-height:280px;color:var(--accent);font-size:120px;box-shadow:0 8px 32px rgba(0,0,0,.4);animation:rotate 20s linear infinite;"><i data-lucide="music"></i></div>
                <div class="pc-song-info">
                    <div id="fullTitlePC" class="pc-title">--</div>
                    <div id="fullArtistPC" class="pc-artist">--</div>
                </div>
            </div>
            <div class="lyrics-container" style="display:none;">
                <div id="inlineLyrics" class="inline-lyrics"></div>
            </div>
        </div>
    </div>
    <div class="full-player-song-info">
        <div id="fullTitle" class="full-title">--</div>
        <div id="fullArtist" class="full-artist">--</div>
    </div>
    <div class="full-player-progress">
        <span id="currentTime" class="time">00:00</span>
        <div id="fullProgressWrapper" class="full-progress">
            <div id="fullProgressBar" class="full-bar"></div>
            <div id="fullProgressHandle" class="full-handle"></div>
        </div>
        <span id="totalTime" class="time">00:00</span>
    </div>
    <div class="full-player-controls">
        <button id="fullModeBtn" class="control-btn"><i data-lucide="repeat"></i></button>
        <button id="fullPrevBtn" class="control-btn"><i data-lucide="skip-back"></i></button>
        <button id="fullPlayBtn" class="control-btn play-btn"><i data-lucide="play"></i></button>
        <button id="fullNextBtn" class="control-btn"><i data-lucide="skip-forward"></i></button>
        <button id="fullFavBtn" class="control-btn"><i data-lucide="heart"></i></button>
    </div>
    <div class="full-player-actions">
        <button id="fullDownloadBtn" class="action-btn"><i data-lucide="download"></i></button>
        <button id="fullLyricsBtn" class="action-btn"><i data-lucide="type"></i></button>
        <button id="fullMuteBtn" class="action-btn"><i data-lucide="volume-2"></i></button>
        <button id="fullListBtn" class="action-btn"><i data-lucide="list"></i></button>
    </div>

    <!-- 歌词视图 -->
    <div id="lyricsView" class="lyrics-view" style="display:none;">
        <div class="full-player-header">
            <button id="lyricsBackBtn" class="close-btn"><i data-lucide="arrow-left"></i></button>
            <div class="song-info">
                <div id="lyricsTitle" class="full-title">--</div>
                <div id="lyricsArtist" class="full-artist">--</div>
            </div>
            <button id="lyricsStyleBtn" class="close-btn"><i data-lucide="palette"></i></button>
        </div>
        <div id="lyricsScroll" class="lyrics-scroll-full"></div>
        <div class="lyrics-controls">
            <button id="jumpPrev" class="lyrics-btn">上一句</button>
            <button id="jumpNext" class="lyrics-btn">下一句</button>
        </div>
        <button id="lyricsPlayBtn" class="lyrics-play-btn"><i data-lucide="play"></i></button>
    </div>

    <!-- 音量控制面板 -->
    <div id="volumePanel" class="volume-panel" style="display:none;">
        <div class="volume-header">
            <button id="volumeBackBtn" class="close-btn"><i data-lucide="arrow-left"></i></button>
            <div class="volume-title">音量控制</div>
            <div style="width:40px;"></div>
        </div>
        <div class="volume-content">
            <div class="volume-display">
                <span id="volumeValue">70</span>%
            </div>
            <input id="volumeSlider" class="volume-slider-full" type="range" min="0" max="1" step="0.01" value="0.7">
            <div class="volume-buttons">
                <button id="muteBtn" class="volume-btn"><i data-lucide="volume-2"></i></button>
                <button class="volume-preset" data-volume="0.3">30%</button>
                <button class="volume-preset" data-volume="0.5">50%</button>
                <button class="volume-preset" data-volume="0.7">70%</button>
                <button class="volume-preset" data-volume="1.0">100%</button>
            </div>
        </div>
    </div>

    <!-- 播放列表视图 -->
    <div id="playlistView" class="playlist-view" style="display:none;">
        <div class="full-player-header">
            <button id="playlistBackBtn" class="close-btn"><i data-lucide="arrow-left"></i></button>
            <div class="song-info">
                <div class="full-title">播放列表</div>
            </div>
            <div style="width:40px;"></div>
        </div>
        <div class="playlist-controls">
            <button id="playlistModeBtn" class="playlist-mode-btn"><i data-lucide="repeat"></i></button>
            <div class="playlist-batch-controls">
                <button id="selectAllBtn" class="batch-btn">全选</button>
                <button id="batchDownloadBtn" class="batch-btn">下载</button>
                <button id="cancelBatchBtn" class="batch-btn">取消</button>
            </div>
            <button id="batchModeBtn" class="playlist-mode-btn"><i data-lucide="download"></i></button>
        </div>
        <div class="playlist-opacity-control">
            <span style="font-size:12px;color:var(--text-sub);">透明度</span>
            <input id="playlistOpacitySlider" class="opacity-slider" type="range" min="0.3" max="1" step="0.1" value="0.9">
        </div>
        <div id="playlistScroll" class="playlist-scroll"></div>
    </div>
</div>

<!-- 免责声明弹窗 -->
<div id="disclaimerModal" class="disclaimer-modal">
    <div class="disclaimer-content">
        <div class="disclaimer-title">免责声明</div>
        <div class="disclaimer-text">
            本站所有数据均系网友搜集自互联网后分享，仅供音乐爱好者交流使用。<br><br>
            音频版权归原网站及版权方所有，本站不提供任何音频存储和贩卖服务，支持购买正版音乐。<br><br>
            如内容侵犯您的权益，请通过以下方式联系我们删除：<br><br>
            QQ: 37010871
        </div>
        <button class="disclaimer-close" id="disclaimerClose">我知道了</button>
    </div>
</div>

<!-- 音频 -->
<audio id="audio" preload="none"></audio>

<script>
    (function(){
        const state={
            enabledSources:{migu:false,netease:true,qq:false,kuwo:false},
            perLimit:20,
            keyword:'',
            results:[],
            favorites:[],
            playlists:[],
            history:[],
            searchHistory:[],
            current:null,
            playing:false,
            mode:'list',
            lyrics:[],
            lyricIndex:-1,
            noMore:false,
            isSearching:false,
            volume:0.7,
            muted:false,
            selectedTracks:[],
            batchMode:false,
            quality:'high',
            lyricsStyle:0,
            appStyle:0
        };

        // 本地存储
        function saveData(){localStorage.setItem('musicbox',JSON.stringify({favorites:state.favorites,history:state.history,searchHistory:state.searchHistory,enabledSources:state.enabledSources,mode:state.mode,volume:state.volume,quality:state.quality,perLimit:state.perLimit}));}
        function loadData(){try{const d=JSON.parse(localStorage.getItem('musicbox')||'{}');Object.assign(state,d);if(!state.history)state.history=[];if(!state.searchHistory)state.searchHistory=[];if(!state.quality)state.quality='high';if(!state.perLimit)state.perLimit=20;}catch(e){}}
        const dom={};
        function $(id){return document.getElementById(id);}
        function toast(msg){
            const el=document.createElement('div');
            el.style.cssText="position:fixed;left:50%;bottom:60px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:6px 14px;border-radius:14px;font-size:12px;z-index:200";
            el.textContent=msg;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(),1500);
        }
        function fmt(s){
            if(!isFinite(s)||s<0)s=0;
            const m=Math.floor(s/60);
            const sec=Math.floor(s%60);
            return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
        }
        function setLoading(v){
            const loading = $('loading');
            const searchIcon = $('searchIcon');
            if(v){
                loading.style.display='block';
                searchIcon.style.display='none';
            }else{
                loading.style.display='none';
                searchIcon.style.display='block';
            }
        }

        // 加载默认网易云推荐
        async function loadDefault(){
            if(state.keyword) return;
            setLoading(true);
            state.isSearching=true;
            try{
                const url=`https://api-v1.cenguigui.cn/api/music/netease/WyY_Dg.php?type=json&msg=热歌榜&num=${state.perLimit}&n=`;
                const res=await fetch(url);
                const j=await res.json();
                if(j.code===200&&Array.isArray(j.data)){
                    j.data.forEach(it=>{
                        const uid=`netease-${it.songid}`;
                        if(state.results.find(t=>t.uid===uid))return;
                        state.results.push({
                            uid,source:'netease',songid:it.songid,
                            title:it.title,singer:it.singer,
                            cover:it.pic||null,url:null,lrc:null,done:false
                        });
                    });
                }
            }catch(e){}
            setLoading(false);
            state.isSearching=false;
            renderList();
            // 默认加载完成后自动显示第一首歌曲信息
            if(state.results.length > 0) {
                showFirstTrack();
            }
        }

        async function searchAll(reset){
            if(reset){state.results=[];state.noMore=false;}
            const kw=state.keyword.trim();
            if(kw&&!state.searchHistory.includes(kw)){state.searchHistory.unshift(kw);state.searchHistory=state.searchHistory.slice(0,10);saveData();}
            const enabled=Object.keys(state.enabledSources).filter(k=>state.enabledSources[k]);
            if(!enabled.length){toast('请至少选择一个来源');return;}

            // 检查是否有支持无关键词搜索的源
            const supportsEmpty=['migu','netease'];
            const hasEmptySupport=enabled.some(src=>supportsEmpty.includes(src));

            if(!kw&&!hasEmptySupport){
                toast('请输入搜索关键词');
                return;
            }

            setLoading(true);
            state.isSearching=true;
            const tasks=enabled.map(src=>{
                // 只有支持无关键词的源才在无关键词时搜索
                if(!kw&&!supportsEmpty.includes(src))return Promise.resolve(0);
                if(src==='migu')return searchMigu(state.keyword,state.perLimit);
                if(src==='netease')return searchNetease(state.keyword,state.perLimit);
                return searchQQKuwo(state.keyword,state.perLimit,src);
            });
            let added=0;
            try{const res=await Promise.all(tasks);added=res.reduce((a,b)=>a+b,0);}catch(e){toast('搜索出错');}
            setLoading(false);
            state.isSearching=false;
            if(!reset&&added===0){state.noMore=true;toast('没有更多了');}
            renderList();
            // 搜索完成后自动显示第一首歌曲信息
            if(reset && state.results.length > 0) {
                showFirstTrack();
            }
        }
        async function searchMigu(kw,limit){
            const url=`https://api-v1.cenguigui.cn/api/music/mgmusic_lingsheng.php?msg=${encodeURIComponent(kw||'')}&limit=${limit}&n=`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!Array.isArray(j.data))return 0;let added=0;j.data.forEach(it=>{const uid=`migu-${kw||''}-${it.n||0}-${it.title}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:'migu',title:it.title,singer:it.singer,cover:null,url:null,lrc:null,done:false});added++;});return added;
        }
        async function searchNetease(kw,limit){
            const url=`https://api-v1.cenguigui.cn/api/music/netease/WyY_Dg.php?type=json&msg=${encodeURIComponent(kw||'热歌榜')}&num=${limit}&n=`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!Array.isArray(j.data))return 0;let added=0;j.data.forEach(it=>{const uid=`netease-${it.songid}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:'netease',songid:it.songid,title:it.title,singer:it.singer,cover:it.pic||null,url:null,lrc:null,done:false});added++;});return added;
        }
        async function searchQQKuwo(kw,limit,src){
            const url=`https://music-dl.sayqz.com/api?type=search&keyword=${encodeURIComponent(kw)}&source=${src}&limit=${limit}`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!j.data||!Array.isArray(j.data.results))return 0;let added=0;j.data.results.forEach(it=>{const uid=`${src}-${it.id}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:src,title:it.name,singer:it.artist,cover:it.pic,url:it.url,lrc:it.lrc,done:!!it.url});added++;});return added;
        }
        async function ensureDetail(track){
            if(track.done&&track.url)return;
            if(track.source==='migu'){const br=state.quality==='lossless'?'1':state.quality==='high'?'2':'3';const url=`https://api-v1.cenguigui.cn/api/mg_music/?msg=${encodeURIComponent(track.title)}&n=1&type=json&br=${br}`;const res=await fetch(url);const j=await res.json();if(j.code===200&&j.data){track.url=j.data.music_url;track.cover=j.data.cover;track.lrc=j.data.lrc_url?await(await fetch(j.data.lrc_url)).text():null;track.done=true;}}
            if(track.source==='netease'){const level=state.quality==='lossless'?'lossless':state.quality==='high'?'exhigh':'standard';const url=`https://api.cenguigui.cn/api/netease/music_v1.php?id=${track.songid}&type=json&level=${level}`;const res=await fetch(url);const j=await res.json();if(j.code===200&&j.data){track.url=j.data.url;track.cover=j.data.pic;track.lrc=j.data.lyric;track.done=true;}}
        }
        function parseLRC(txt){if(!txt)return[];const lines=txt.split(/\r?\n/);const reg=/\[(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?\]/;const out=[];lines.forEach(line=>{const m=reg.exec(line);if(!m)return;const time=parseInt(m[1])*60+parseInt(m[2])+((m[3]?parseInt(m[3].padEnd(3,'0')):0)/1000);const text=line.replace(reg,'').trim();if(text)out.push({time,text});});out.sort((a,b)=>a.time-b.time);return out;}
        function renderSearchHistory(){
            const wrap=$('searchHistory');
            if(state.searchHistory.length){
                wrap.innerHTML='';
                state.searchHistory.forEach(kw=>{
                    const btn=document.createElement('button');
                    btn.className='search-history-btn';
                    btn.textContent=kw;
                    btn.onclick=()=>{$('searchInput').value=kw;state.keyword=kw;searchAll(true);wrap.classList.remove('show');};
                    wrap.appendChild(btn);
                });
                wrap.classList.add('show');
            }else{
                wrap.classList.remove('show');
            }
        }
        function renderList(){
            const wrap=$('scroll');wrap.innerHTML='';const tab=document.querySelector('.tab.active').dataset.tab;let list=[];
            if(tab==='results')list=state.results;
            else if(tab==='favorites')list=state.favorites;
            else if(tab==='playlists'){
                if(state.history.length){
                    const headerDiv=document.createElement('div');
                    headerDiv.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 0;';
                    headerDiv.innerHTML='<span style="color:var(--text-sub);font-size:14px;">播放历史</span><button id="clearHistoryBtn" style="padding:4px 8px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.1);color:var(--text-sub);font-size:12px;cursor:pointer;">清空历史</button>';
                    wrap.appendChild(headerDiv);
                    state.history.slice(0,20).forEach((tr,idx)=>{
                        const row=document.createElement('div');row.className='track';const srcTag=tr.source==='migu'?'咪咕':tr.source==='netease'?'网易云':tr.source==='qq'?'QQ':'酷我';
                        row.innerHTML=`<div class="index">${idx+1}</div><img class="cover" src="${tr.cover||''}" style="display:${tr.cover?'block':'none'}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" onload="this.style.display='block';this.nextElementSibling.style.display='none'"><div class="cover-placeholder" style="width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,rgba(255,205,50,.15),rgba(255,183,77,.15));display:${tr.cover?'none':'flex'};margin-right:12px;flex-shrink:0;align-items:center;justify-content:center;color:var(--accent);font-size:22px;box-shadow:0 2px 6px rgba(255,205,50,.2);"><i data-lucide="music"></i></div><div class="info"><div class="title">${tr.title||'Unknown'}</div><div class="artist"><span class="source-tag source-${tr.source}">${srcTag}</span>${tr.singer||''}</div></div><button class="playbtn"><i data-lucide="play"></i></button>`;
                        row.querySelector('.playbtn').onclick=async(e)=>{window.event=e;await playTrack(tr);};row.onclick=()=>row.querySelector('.playbtn').click();wrap.appendChild(row);
                    });
                    // 添加清空历史按钮事件
                    const clearBtn=document.getElementById('clearHistoryBtn');
                    if(clearBtn){
                        clearBtn.onclick=()=>{
                            if(confirm('确定要清空所有播放历史吗？')){
                                state.history=[];
                                saveData();
                                renderList();
                                toast('播放历史已清空');
                            }
                        };
                    }
                }
                if(state.searchHistory.length){
                    const histDiv=document.createElement('div');histDiv.style.cssText='padding:20px 0 10px;color:var(--text-sub);font-size:14px;';histDiv.textContent='搜索历史';wrap.appendChild(histDiv);
                    state.searchHistory.forEach(kw=>{
                        const btn=document.createElement('button');btn.style.cssText='margin:4px 8px 4px 0;padding:4px 12px;border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.1);color:var(--text-main);font-size:12px;cursor:pointer;';
                        btn.textContent=kw;btn.onclick=()=>{$('searchInput').value=kw;state.keyword=kw;searchAll(true);};wrap.appendChild(btn);
                    });
                }
                return;
            }
            list.forEach((tr,idx)=>{const row=document.createElement('div');row.className='track';const srcTag=tr.source==='migu'?'咪咕':tr.source==='netease'?'网易云':tr.source==='qq'?'QQ':'酷我';row.innerHTML=`<div class="index">${idx+1}</div><img class="cover" src="${tr.cover||''}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" onload="this.style.display='block';this.nextElementSibling.style.display='none'"><div class="cover-placeholder" style="width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,rgba(255,205,50,.15),rgba(255,183,77,.15));display:${tr.cover?'none':'flex'};margin-right:12px;flex-shrink:0;align-items:center;justify-content:center;color:var(--accent);font-size:22px;box-shadow:0 2px 6px rgba(255,205,50,.2);"><i data-lucide="music"></i></div><div class="info"><div class="title">${tr.title||'Unknown'}</div><div class="artist"><span class="source-tag source-${tr.source}">${srcTag}</span>${tr.singer||''}</div></div><button class="playbtn"><i data-lucide="play"></i></button>`;const playBtn=row.querySelector('.playbtn');playBtn.onclick=async(e)=>{e.stopPropagation();if(state.current&&state.current.uid===tr.uid&&state.current.url){if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();}else{await playTrack(tr,playBtn);}};row.onclick=()=>playBtn.click();wrap.appendChild(row);});
        }
        async function playTrack(track, clickedBtn){
            // 显示加载状态
            if(clickedBtn) {
                clickedBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
                setTimeout(()=>lucide.createIcons(),10);
            }

            state.current=track;
            // 立即清空歌词状态
            state.lyrics=[];
            state.lyricIndex=-1;
            $('lyricsScroll').innerHTML='<div style="margin-top:30px;color:var(--text-sub)">加载中...</div>';
            $('inlineLyrics').innerHTML='';

            try {
                await ensureDetail(track);
                if(!track.url){toast('播放失败');updateUI();return;}

                const histIdx=state.history.findIndex(t=>t.uid===track.uid);
                if(histIdx>=0)state.history.splice(histIdx,1);
                state.history.unshift({...track});
                state.history=state.history.slice(0,50);
                saveData();

                $('audio').src=track.url;
                await $('audio').play();
                state.playing=true;
                updateUI();

                state.lyrics=track.lrc?parseLRC(track.lrc):[];
                renderLyrics();
                renderInlineLyrics();
            } catch(e) {
                toast('播放失败');
                updateUI();
            }
        }
        function showFirstTrack(){
            if(state.results.length > 0){
                const firstTrack = state.results[0];
                state.current = firstTrack;
                state.playing = false;
                // 不预加载音频详情，只显示基本信息
                updateUI();
            }
        }
        function updateUI(){const tr=state.current;$('title').textContent=tr?tr.title:'暂未选择歌曲';const artistText=tr?tr.singer:'点击选择音乐';const qualityText=tr?state.quality==='lossless'?'无损':state.quality==='high'?'高品质':'标准':'';const qualityClass=tr?`quality-${state.quality}`:'';$('artist').innerHTML=tr?`${artistText} <span class="quality-tag ${qualityClass}">${qualityText}</span>`:artistText;if($('fullTitle'))$('fullTitle').textContent=tr?tr.title:'--';if($('fullArtist'))$('fullArtist').innerHTML=tr?`${tr.singer} <span class="full-quality-tag full-${qualityClass}">${qualityText}</span>`:'--';if($('fullTitlePC'))$('fullTitlePC').textContent=tr?tr.title:'--';if($('fullArtistPC'))$('fullArtistPC').innerHTML=tr?`${tr.singer} <span class="full-quality-tag full-${qualityClass}">${qualityText}</span>`:'--';const coverImg=$('cover');const coverPlaceholder=$('coverPlaceholder');const fullCoverImg=$('fullCover');const fullCoverPlaceholder=document.querySelector('.full-cover-placeholder');if(tr&&tr.cover){if(coverImg){coverImg.src=tr.cover;coverImg.style.display='block';coverImg.onerror=()=>{coverImg.style.display='none';if(coverPlaceholder)coverPlaceholder.style.display='flex';};}if(coverPlaceholder)coverPlaceholder.style.display='none';if(fullCoverImg){fullCoverImg.src=tr.cover;fullCoverImg.style.display='block';fullCoverImg.onerror=()=>{fullCoverImg.style.display='none';if(fullCoverPlaceholder)fullCoverPlaceholder.style.display='block';};}if(fullCoverPlaceholder)fullCoverPlaceholder.style.display='none';}else{if(coverImg)coverImg.style.display='none';if(coverPlaceholder)coverPlaceholder.style.display='flex';if(fullCoverImg)fullCoverImg.style.display='none';if(fullCoverPlaceholder)fullCoverPlaceholder.style.display='block';}$('playPauseBtn').innerHTML=state.playing?'<i data-lucide="pause"></i>':'<i data-lucide="play"></i>';if($('fullPlayBtn'))$('fullPlayBtn').innerHTML=state.playing?'<i data-lucide="pause"></i>':'<i data-lucide="play"></i>';if($('lyricsPlayBtn'))$('lyricsPlayBtn').innerHTML=state.playing?'<i data-lucide="pause"></i>':'<i data-lucide="play"></i>';const isFav=tr&&state.favorites.find(f=>f.uid===tr.uid);if($('fullFavBtn')){$('fullFavBtn').innerHTML=isFav?'<i data-lucide="heart" fill="#ff6b6b"></i>':'<i data-lucide="heart"></i>';$('fullFavBtn').style.color=isFav?'#ff6b6b':'var(--text-main)';}$('favBtn').innerHTML=isFav?'<i data-lucide="heart" fill="#ff6b6b"></i>':'<i data-lucide="heart"></i>';$('favBtn').style.color=isFav?'#ff6b6b':'var(--text-main)';document.querySelectorAll('.track').forEach(el=>{const uid=state.current?state.current.uid:null;const list=[...state.results,...state.favorites,...state.history];const track=list.find(t=>t.uid===uid);el.classList.toggle('playing',track&&el.querySelector('.playbtn').onclick.toString().includes(track.uid));});document.querySelectorAll('.playbtn').forEach(btn=>{const trackRow=btn.closest('.track');if(trackRow){const isCurrentTrack=state.current&&trackRow.querySelector('.title').textContent===state.current.title;btn.innerHTML=isCurrentTrack&&state.playing?'<i data-lucide="pause"></i>':'<i data-lucide="play"></i>';}});$('player').classList.toggle('show',!!tr);renderIconsOptimized();}
        function renderLyrics(){
            const wrap=$('lyricsScroll');
            const inlineEl=$('inlineLyrics');
            if(!wrap)return;
            if(!state.lyrics.length){
                wrap.innerHTML='<div style="text-align:center;color:var(--text-sub);margin-top:100px;">暂无歌词</div>';
                if(inlineEl)inlineEl.innerHTML='<div style="text-align:center;color:var(--text-sub);">暂无歌词</div>';
                return;
            }

            // 渲染歌词行，添加点击跳转功能
            const html=state.lyrics.map((l,i)=>`<div data-time="${l.time}" data-index="${i}" style="cursor:pointer;">${l.text}</div>`).join('');
            wrap.innerHTML=html;
            if(inlineEl)inlineEl.innerHTML=html;

            // 添加点击跳转事件
            wrap.querySelectorAll('div[data-time]').forEach(div => {
                div.addEventListener('click', () => {
                    const time = parseFloat(div.dataset.time);
                    if (dom.audio && isFinite(time)) {
                        dom.audio.currentTime = time;
                        toast('已跳转到指定位置');
                    }
                });
            });

            if(inlineEl) {
                inlineEl.querySelectorAll('div[data-time]').forEach(div => {
                    div.addEventListener('click', () => {
                        const time = parseFloat(div.dataset.time);
                        if (dom.audio && isFinite(time)) {
                            dom.audio.currentTime = time;
                            toast('已跳转到指定位置');
                        }
                    });
                });
            }

            $('lyricsTitle').textContent=state.current?state.current.title:'--';
            $('lyricsArtist').textContent=state.current?state.current.singer:'--';
        }
        function renderPlaylist(){
            const wrap=$('playlistScroll');
            wrap.innerHTML='';
            const currentTab=document.querySelector('.tab.active').dataset.tab;
            let list=[];
            if(currentTab==='results')list=state.results;
            else if(currentTab==='favorites')list=state.favorites;
            else list=state.history;

            // 更新全选按钮文本
            const allSelected=list.length>0&&list.every(t=>state.selectedTracks.includes(t.uid));
            if($('selectAllBtn'))$('selectAllBtn').textContent=allSelected?'取消全选':'全选';

            list.forEach((tr,idx)=>{
                const item=document.createElement('div');
                item.className='playlist-item';
                if(state.batchMode)item.classList.add('batch-mode');
                if(state.current&&state.current.uid===tr.uid)item.classList.add('active');
                const isSelected=state.selectedTracks.includes(tr.uid);
                item.innerHTML=`<input type="checkbox" class="checkbox" ${isSelected?'checked':''}><div class="index">${idx+1}</div><div class="info"><div class="title">${tr.title||'Unknown'}</div><div class="artist">${tr.singer||''}</div></div>`;

                const checkbox=item.querySelector('.checkbox');
                checkbox.onchange=()=>{
                    if(checkbox.checked){
                        if(!state.selectedTracks.includes(tr.uid))state.selectedTracks.push(tr.uid);
                    }else{
                        state.selectedTracks=state.selectedTracks.filter(uid=>uid!==tr.uid);
                    }
                    // 更新全选按钮状态
                    const allSelected=list.length>0&&list.every(t=>state.selectedTracks.includes(t.uid));
                    if($('selectAllBtn'))$('selectAllBtn').textContent=allSelected?'取消全选':'全选';
                };

                if(!state.batchMode){
                    item.onclick=async(e)=>{if(e.target===checkbox)return;await playTrack(tr);renderPlaylist();};
                }

                wrap.appendChild(item);
            });
            setTimeout(()=>lucide.createIcons(),10);
        }
        // 专业级歌词滚动控制
        let lyricsScrollAnimation = null;
        let inlineScrollAnimation = null;

        function smoothScrollTo(container, targetTop, duration = 600) {
            const startTop = container.scrollTop;
            const distance = targetTop - startTop;
            const startTime = performance.now();

            // 专业级缓动函数 - 更自然的动画曲线
            function easeOutQuart(t) {
                return 1 - Math.pow(1 - t, 4);
            }

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = easeOutQuart(progress);

                container.scrollTop = startTop + distance * easedProgress;

                if (progress < 1) {
                    return requestAnimationFrame(animate);
                }
            }

            return requestAnimationFrame(animate);
        }

        function updateLyrics(time){
            if(!state.lyrics.length)return;
            let idx=state.lyrics.findIndex((l,i)=>{
                const next=state.lyrics[i+1];
                return time>=l.time&&(next?time<next.time:true);
            });
            if(idx<0||idx===state.lyricIndex)return;
            state.lyricIndex=idx;

            // 取消之前的滚动动画
            if(lyricsScrollAnimation) {
                cancelAnimationFrame(lyricsScrollAnimation);
                lyricsScrollAnimation = null;
            }

            document.querySelectorAll('#lyricsScroll div').forEach((el,i)=>{
                el.classList.toggle('active',i===idx);
                // 专业级透明度渐变
                const distance = Math.abs(i - idx);
                let opacity;
                if(distance === 0) opacity = 1;
                else if(distance === 1) opacity = 0.7;
                else if(distance === 2) opacity = 0.5;
                else if(distance === 3) opacity = 0.3;
                else opacity = 0.15;
                el.style.opacity = opacity;
            });

            // 专业级滚动动画
            const active=$('lyricsScroll').querySelector('.active');
            if(active){
                const container = $('lyricsScroll');
                const containerHeight = container.clientHeight;
                const activeTop = active.offsetTop;
                const activeHeight = active.clientHeight;
                const targetScrollTop = activeTop - (containerHeight / 2) + (activeHeight / 2);

                // 智能滚动距离判断
                const scrollDistance = Math.abs(targetScrollTop - container.scrollTop);
                const duration = Math.min(800, Math.max(400, scrollDistance * 1.2));

                lyricsScrollAnimation = smoothScrollTo(container, targetScrollTop, duration);
            }

            // 同时更新内联歌词
            updateInlineLyrics(time);
        }

        function renderInlineLyrics(){
            const wrap=$('inlineLyrics');
            const container=document.querySelector('.lyrics-container');
            if(!wrap || !container) return;

            // PC和手机端都显示歌词容器
            if(state.lyrics.length > 0) {
                container.style.display = window.innerWidth >= 768 ? 'block' : 'none';
                wrap.innerHTML = '';
                state.lyrics.forEach((l,i)=>{
                    const div=document.createElement('div');
                    div.textContent=l.text;
                    div.dataset.idx=i;
                    div.dataset.time=l.time;
                    wrap.appendChild(div);
                });
            } else {
                container.style.display = 'none';
            }
        }

        function updateInlineLyrics(time){
            if(!state.lyrics.length||!$('inlineLyrics'))return;
            let idx=state.lyrics.findIndex((l,i)=>{
                const next=state.lyrics[i+1];
                return time>=l.time&&(next?time<next.time:true);
            });
            if(idx<0)return;

            // 取消之前的滚动动画
            if(inlineScrollAnimation) {
                cancelAnimationFrame(inlineScrollAnimation);
                inlineScrollAnimation = null;
            }

            document.querySelectorAll('#inlineLyrics div').forEach((el,i)=>{
                el.classList.toggle('active',i===idx);
                // 专业级透明度渐变
                const distance = Math.abs(i - idx);
                let opacity;
                if(distance === 0) opacity = 1;
                else if(distance === 1) opacity = 0.7;
                else if(distance === 2) opacity = 0.5;
                else if(distance === 3) opacity = 0.3;
                else opacity = 0.15;
                el.style.opacity = opacity;
            });

            // 专业级滚动动画
            const active=$('inlineLyrics').querySelector('.active');
            if(active){
                const container = document.querySelector('.lyrics-container');
                if(container) {
                    const containerHeight = container.clientHeight;
                    const activeTop = active.offsetTop - container.offsetTop;
                    const activeHeight = active.clientHeight;
                    const targetScrollTop = Math.max(0, activeTop - (containerHeight / 2) + (activeHeight / 2));

                    // 智能滚动距离判断
                    const scrollDistance = Math.abs(targetScrollTop - container.scrollTop);
                    const duration = Math.min(800, Math.max(400, scrollDistance * 1.2));

                    inlineScrollAnimation = smoothScrollTo(container, targetScrollTop, duration);
                }
            }
        }
        function updateVolumeDisplay(){
            const vol=Math.round(dom.audio.volume*100);
            $('volumeValue').textContent=vol;
        }

        function toggleFav(){if(!state.current)return;const idx=state.favorites.findIndex(t=>t.uid===state.current.uid);if(idx>=0){state.favorites.splice(idx,1);toast('已取消收藏');}else{state.favorites.push(state.current);toast('已收藏');}saveData();updateUI();renderList();}
        function nextTrack(dir){const tab=document.querySelector('.tab.active').dataset.tab;let list=[];if(tab==='results')list=state.results;else if(tab==='favorites')list=state.favorites;else if(tab==='playlists')list=state.history;if(!list.length)return;let idx=list.findIndex(t=>t.uid===state.current.uid);if(idx<0)idx=0;if(state.mode==='single'){$('audio').currentTime=0;$('audio').play();return;}if(state.mode==='shuffle'){if(list.length===1)idx=0;else{let n;do{n=Math.floor(Math.random()*list.length);}while(n===idx);idx=n;}}else{idx=(idx+(dir==='prev'?-1:1)+list.length)%list.length;}playTrack(list[idx]);}

        function togglePlayMode(){
            const modes=['list','single','shuffle'];
            const idx=modes.indexOf(state.mode);
            state.mode=modes[(idx+1)%modes.length];
            saveData();
            updateModeUI();
            const modeNames={list:'列表播放',single:'单曲循环',shuffle:'随机播放'};
            toast(modeNames[state.mode]);
        }
        function updateModeUI(){
            const icons={list:'repeat',single:'repeat-1',shuffle:'shuffle'};
            if($('fullModeBtn')){
                $('fullModeBtn').innerHTML=`<i data-lucide="${icons[state.mode]}"></i>`;
                setTimeout(()=>lucide.createIcons(),10);
            }
            updatePlaylistModeUI();
        }
        function updatePlaylistModeUI(){
            const modeBtn=$('playlistModeBtn');
            if(modeBtn){
                const icons={list:'repeat',single:'repeat-1',shuffle:'shuffle'};
                modeBtn.innerHTML=`<i data-lucide="${icons[state.mode]}"></i>`;
                setTimeout(()=>lucide.createIcons(),10);
            }
        }
        async function downloadTrack(track){
            await ensureDetail(track);
            if(!track.url){toast('无法获取下载链接');return;}
            try{
                const response=await fetch(track.url);
                const blob=await response.blob();
                const url=window.URL.createObjectURL(blob);
                const a=document.createElement('a');
                a.href=url;
                a.download=`${track.title}-${track.singer}.mp3`;
                a.target='_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                toast(`${track.title} 开始下载`);
            }catch(e){
                window.open(track.url,'_blank');
                toast(`${track.title} 已在新标签页打开下载链接`);
            }
        }
        async function batchDownload(){
            if(!state.selectedTracks.length){toast('请选择要下载的歌曲');return;}
            const currentTab=document.querySelector('.tab.active').dataset.tab;
            let list=[];
            if(currentTab==='results')list=state.results;
            else if(currentTab==='favorites')list=state.favorites;
            else list=state.history;

            const selectedList=list.filter(t=>state.selectedTracks.includes(t.uid));
            toast(`开始批量下载 ${selectedList.length} 首歌曲`);

            for(const track of selectedList){
                await downloadTrack(track);
                await new Promise(resolve=>setTimeout(resolve,1000));
            }
        }

        function setup(){
            dom.audio=$('audio');dom.searchInput=$('searchInput');dom.playPauseBtn=$('playPauseBtn');dom.nextBtn=$('nextBtn');dom.progressBar=$('progressBar');dom.progressWrapper=$('progressWrapper');dom.progressHandle=$('progressHandle');dom.menuBtn=$('menuBtn');dom.fullPlayerMask=$('fullPlayerMask');dom.fullPlayerPanel=$('fullPlayerPanel');dom.fullPlayerClose=$('fullPlayerClose');dom.fullCover=$('fullCover');dom.fullPlayBtn=$('fullPlayBtn');dom.fullPrevBtn=$('fullPrevBtn');dom.fullNextBtn=$('fullNextBtn');dom.fullFavBtn=$('fullFavBtn');dom.fullModeBtn=$('fullModeBtn');dom.fullDownloadBtn=$('fullDownloadBtn');dom.fullLyricsBtn=$('fullLyricsBtn');dom.fullVolumeBtn=$('fullVolumeBtn');dom.fullProgressWrapper=$('fullProgressWrapper');dom.fullProgressBar=$('fullProgressBar');dom.fullProgressHandle=$('fullProgressHandle');dom.favBtn=$('favBtn');dom.fullListBtn=$('fullListBtn');

            // 缓存进度条相关元素
            progressElements.bar = dom.progressBar;
            progressElements.handle = dom.progressHandle;
            progressElements.fullBar = dom.fullProgressBar;
            progressElements.fullHandle = dom.fullProgressHandle;
            progressElements.currentTime = $('currentTime');
            progressElements.totalTime = $('totalTime');

            // 搜索功能
            function performSearch(){
                state.keyword=dom.searchInput.value.trim();
                const enabled=Object.keys(state.enabledSources).filter(k=>state.enabledSources[k]);
                const supportsEmpty=['migu','netease'];
                const hasEmptySupport=enabled.some(src=>supportsEmpty.includes(src));

                if(state.keyword||hasEmptySupport){
                    searchAll(true);
                }else{
                    toast('请输入搜索关键词或选择支持无关键词搜索的源（网易云/咪咕）');
                }
                $('searchHistory').classList.remove('show');
            }

            dom.searchInput.addEventListener('keydown',e=>{if(e.key==='Enter'){performSearch();}});

            // 搜索按钮点击事件 - 使用多种方式绑定
            document.addEventListener('click', e => {
                if(e.target.id === 'searchIcon' || e.target.closest('#searchIcon')) {
                    performSearch();
                }
            });
            dom.searchInput.addEventListener('focus',()=>{if(state.searchHistory.length)renderSearchHistory();});
            dom.searchInput.addEventListener('blur',()=>{setTimeout(()=>$('searchHistory').classList.remove('show'),200);});
            $('disclaimerOpenBtn').addEventListener('click',()=>{$('disclaimerModal').style.display='flex';});
            $('disclaimerBtn').addEventListener('click',()=>{
                const app = $('app');
                const body = document.body;
                const styles = ['', 'alt-style', 'alt-style-1', 'alt-style-2', 'alt-style-3', 'alt-style-4', 'alt-style-5'];
                const names = ['默认风格', 'Spotify风格', 'Apple Music风格', 'YouTube Music风格', 'Tidal风格', '网易云风格', 'QQ音乐风格'];
                styles.forEach(style => {if(style) {app.classList.remove(style);body.classList.remove(style);}});
                state.appStyle = (state.appStyle + 1) % styles.length;
                if(styles[state.appStyle]) {app.classList.add(styles[state.appStyle]);body.classList.add(styles[state.appStyle]);}
                saveData();
                toast(`切换到${names[state.appStyle]}`);
            });
            $('disclaimerClose').addEventListener('click',()=>{$('disclaimerModal').style.display='none';});
            $('disclaimerModal').addEventListener('click',e=>{if(e.target===$('disclaimerModal'))$('disclaimerModal').style.display='none';});
            document.querySelectorAll('.sourcebar input').forEach(cb=>cb.addEventListener('change',()=>{state.enabledSources[cb.dataset.src]=cb.checked;saveData();}));
            $('limitSelect').addEventListener('change',()=>{state.perLimit=parseInt($('limitSelect').value);saveData();toast(`结果数量已设置为${state.perLimit}条`);if(state.keyword){searchAll(true);}else{loadDefault();}});
            $('qualitySelect').addEventListener('change',()=>{state.quality=$('qualitySelect').value;saveData();toast(`音质已切换至${state.quality==='lossless'?'无损':state.quality==='high'?'高品质':'标准'}`);if(state.keyword){searchAll(true);}else{loadDefault();}});
            document.querySelectorAll('.tab').forEach(tab=>tab.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t===tab));renderList();}));

            dom.playPauseBtn.addEventListener('click',async(e)=>{if(!state.current)return;if(state.current.url){if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();}else{await playTrack(state.current,e.target);}});
            dom.nextBtn.addEventListener('click',()=>nextTrack('next'));
            dom.favBtn.addEventListener('click',toggleFav);
            dom.menuBtn.addEventListener('click',()=>{dom.fullPlayerMask.classList.add('show');dom.fullPlayerPanel.classList.add('show');});

            // 全屏播放器事件
            dom.fullPlayBtn.addEventListener('click',async(e)=>{if(!state.current)return;if(state.current.url){if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();}else{await playTrack(state.current,e.target);}});
            dom.fullPrevBtn.addEventListener('click',()=>nextTrack('prev'));
            dom.fullNextBtn.addEventListener('click',()=>nextTrack('next'));
            dom.fullFavBtn.addEventListener('click',toggleFav);
            dom.fullModeBtn.addEventListener('click',togglePlayMode);
            dom.fullDownloadBtn.addEventListener('click',()=>downloadTrack(state.current));
            $('fullLyricsBtn').addEventListener('click',()=>{
                if(window.innerWidth >= 768) {
                    // PC端切换歌词样式
                    const fullPlayerPanel = $('fullPlayerPanel');
                    const styles = ['', 'alt-style', 'alt-style-1', 'alt-style-2', 'alt-style-3', 'alt-style-4', 'alt-style-5'];
                    const names = ['默认样式', 'Spotify风格', 'Apple Music风格', 'YouTube Music风格', 'Tidal风格', '网易云风格', 'QQ音乐风格'];

                    // 移除所有样式类
                    styles.forEach(style => {
                        if(style) fullPlayerPanel.classList.remove(style);
                    });

                    // 切换到下一个样式
                    state.lyricsStyle = (state.lyricsStyle + 1) % styles.length;
                    if(styles[state.lyricsStyle]) {
                        fullPlayerPanel.classList.add(styles[state.lyricsStyle]);
                    }

                    toast(`切换到${names[state.lyricsStyle]}`);
                } else {
                    // 手机端显示歌词页面
                    showLyrics();
                }
            });
            $('fullPlayerOpacitySlider').addEventListener('input',()=>{const opacity=parseFloat($('fullPlayerOpacitySlider').value);$('fullPlayerPanel').style.background=`linear-gradient(135deg,rgba(26,26,46,${opacity}),rgba(26,31,58,${opacity}))`;});
            $('playlistOpacitySlider').addEventListener('input',()=>{const opacity=parseFloat($('playlistOpacitySlider').value);$('playlistView').style.background=`rgba(26,26,46,${opacity})`;});
            dom.fullListBtn.addEventListener('click',()=>{renderPlaylist();$('playlistView').style.display='flex';$('fullPlayerOpacitySlider').parentElement.style.display='none';setTimeout(()=>lucide.createIcons(),10);});
            $('playlistBackBtn').addEventListener('click',()=>{$('playlistView').style.display='none';$('fullPlayerOpacitySlider').parentElement.style.display='flex';});
            $('playlistModeBtn').addEventListener('click',()=>{
                if(state.mode==='list')state.mode='single';
                else if(state.mode==='single')state.mode='shuffle';
                else state.mode='list';
                updatePlaylistModeUI();
                saveData();
                const modeNames={list:'列表播放',single:'单曲循环',shuffle:'随机播放'};
                toast(modeNames[state.mode]);
            });
            $('batchModeBtn').addEventListener('click',()=>{
                state.batchMode=!state.batchMode;
                state.selectedTracks=[];
                renderPlaylist();
                document.querySelector('.playlist-batch-controls').classList.toggle('show',state.batchMode);
            });
            $('selectAllBtn').addEventListener('click',()=>{
                const currentTab=document.querySelector('.tab.active').dataset.tab;
                let list=[];
                if(currentTab==='results')list=state.results;
                else if(currentTab==='favorites')list=state.favorites;
                else list=state.history;

                const allSelected=list.length>0&&list.every(t=>state.selectedTracks.includes(t.uid));
                if(allSelected){
                    state.selectedTracks=[];
                    $('selectAllBtn').textContent='全选';
                }else{
                    state.selectedTracks=list.map(t=>t.uid);
                    $('selectAllBtn').textContent='取消全选';
                }
                renderPlaylist();
            });
            $('batchDownloadBtn').addEventListener('click',batchDownload);
            $('cancelBatchBtn').addEventListener('click',()=>{
                state.batchMode=false;
                state.selectedTracks=[];
                renderPlaylist();
                document.querySelector('.playlist-batch-controls').classList.remove('show');
            });

            $('fullMuteBtn').addEventListener('click',()=>{state.muted=!state.muted;dom.audio.muted=state.muted;$('fullMuteBtn').innerHTML=state.muted?'<i data-lucide="volume-x"></i>':'<i data-lucide="volume-2"></i>';setTimeout(()=>lucide.createIcons(),10);toast(state.muted?'已静音':'已取消静音');});
            dom.fullProgressWrapper.addEventListener('click',e=>{if(!fullProgressDragging){const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=(e.clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));}});

            // 歌词和音量面板
            $('lyricsBackBtn').addEventListener('click', hideLyrics);

            // 歌词界面右滑返回（触摸和鼠标）
            let lyricsStartX = 0;
            let lyricsMouseStartX = 0;
            let lyricsIsDragging = false;

            $('lyricsView').addEventListener('touchstart', e => {
                lyricsStartX = e.touches[0].clientX;
            });
            $('lyricsView').addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchEndX - lyricsStartX;
                if (diff > 50) { // 右滑超过50px
                    hideLyrics();
                }
            });

            $('lyricsView').addEventListener('mousedown', e => {
                lyricsMouseStartX = e.clientX;
                lyricsIsDragging = true;
            });
            $('lyricsView').addEventListener('mouseup', e => {
                if (lyricsIsDragging) {
                    const diff = e.clientX - lyricsMouseStartX;
                    if (diff > 50) { // 右滑超过50px
                        hideLyrics();
                    }
                    lyricsIsDragging = false;
                }
            });
            $('lyricsView').addEventListener('mouseleave', () => {
                lyricsIsDragging = false;
            });
            $('volumeBackBtn').addEventListener('click',()=>{$('volumePanel').style.display='none';});
            document.querySelectorAll('.volume-preset').forEach(btn=>btn.addEventListener('click',()=>{const vol=parseFloat(btn.dataset.volume);dom.audio.volume=vol;state.volume=vol;saveData();}));
            // 歌词跳转按钮
            $('jumpPrev').addEventListener('click',()=>{
                if(state.lyricIndex>0){
                    const time=state.lyrics[state.lyricIndex-1].time;
                    dom.audio.currentTime=time;
                    toast('跳转到上一句');
                }
            });
            $('jumpNext').addEventListener('click',()=>{
                if(state.lyricIndex<state.lyrics.length-1){
                    const time=state.lyrics[state.lyricIndex+1].time;
                    dom.audio.currentTime=time;
                    toast('跳转到下一句');
                }
            });

            // 歌词样式切换
            $('lyricsStyleBtn').addEventListener('click', () => {
                const lyricsView = $('lyricsView');
                const styles = ['', 'alt-style', 'alt-style-1', 'alt-style-2', 'alt-style-3', 'alt-style-4', 'alt-style-5'];
                const names = ['默认样式', 'Spotify风格', 'Apple Music风格', 'YouTube Music风格', 'Tidal风格', '网易云风格', 'QQ音乐风格'];

                // 移除所有样式类
                styles.forEach(style => {
                    if(style) lyricsView.classList.remove(style);
                });

                // 切换到下一个样式
                state.lyricsStyle = (state.lyricsStyle + 1) % styles.length;
                if(styles[state.lyricsStyle]) {
                    lyricsView.classList.add(styles[state.lyricsStyle]);
                }

                toast(`切换到${names[state.lyricsStyle]}`);
            });

            // 进度条拖动功能（鼠标和触摸）
            let progressDragging = false;
            let fullProgressDragging = false;

            // 底部进度条
            dom.progressWrapper.addEventListener('mousedown',e=>{progressDragging=true;const rect=dom.progressWrapper.getBoundingClientRect();const r=(e.clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});
            dom.progressWrapper.addEventListener('touchstart',e=>{progressDragging=true;const rect=dom.progressWrapper.getBoundingClientRect();const r=(e.touches[0].clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});

            document.addEventListener('mousemove',e=>{if(progressDragging){const rect=dom.progressWrapper.getBoundingClientRect();const r=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));const dur=dom.audio.duration||0;dom.audio.currentTime=dur*r;}});
            document.addEventListener('touchmove',e=>{if(progressDragging){const rect=dom.progressWrapper.getBoundingClientRect();const r=Math.max(0,Math.min(1,(e.touches[0].clientX-rect.left)/rect.width));const dur=dom.audio.duration||0;dom.audio.currentTime=dur*r;}});

            document.addEventListener('mouseup',()=>{progressDragging=false;});
            document.addEventListener('touchend',()=>{progressDragging=false;});

            // 全屏进度条
            dom.fullProgressWrapper.addEventListener('mousedown',e=>{fullProgressDragging=true;const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=(e.clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});
            dom.fullProgressWrapper.addEventListener('touchstart',e=>{fullProgressDragging=true;const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=(e.touches[0].clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});

            document.addEventListener('mousemove',e=>{if(fullProgressDragging){const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));const dur=dom.audio.duration||0;dom.audio.currentTime=dur*r;}});
            document.addEventListener('touchmove',e=>{if(fullProgressDragging){const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=Math.max(0,Math.min(1,(e.touches[0].clientX-rect.left)/rect.width));const dur=dom.audio.duration||0;dom.audio.currentTime=dur*r;}});

            document.addEventListener('mouseup',()=>{fullProgressDragging=false;});
            document.addEventListener('touchend',()=>{fullProgressDragging=false;});
            dom.audio.addEventListener('timeupdate', () => {
                if (!state.playing) return;
                updateProgressBars();
                updateTimeDisplay();
                updateLyrics(dom.audio.currentTime || 0);
            });
            dom.audio.addEventListener('ended',()=>nextTrack('next'));dom.audio.addEventListener('play',()=>{state.playing=true;updateUI();if(dom.fullCover)dom.fullCover.classList.remove('paused');});dom.audio.addEventListener('pause',()=>{state.playing=false;updateUI();if(dom.fullCover)dom.fullCover.classList.add('paused');});

            document.querySelectorAll('.controls button').forEach(btn=>btn.addEventListener('click',e=>e.stopPropagation()));
            document.querySelector('.cover-wrapper').addEventListener('click',e=>e.stopPropagation());
            document.querySelector('.player').addEventListener('click',()=>{
                if(!state.current)return;
                dom.fullPlayerMask.classList.add('show');
                dom.fullPlayerPanel.classList.add('show');
            });

            dom.fullPlayerClose.addEventListener('click',closeFullPlayer);
            dom.fullPlayerMask.addEventListener('click',closeFullPlayer);

            // 左滑手势显示歌词（触摸和鼠标）
            let touchStartX = 0;
            let mouseStartX = 0;
            let isDragging = false;

            function showLyrics() {
                $('lyricsView').style.display = 'flex';
                $('fullPlayerOpacitySlider').parentElement.style.display = 'none';
                setTimeout(() => $('lyricsView').classList.add('show'), 10);
            }

            function hideLyrics() {
                $('lyricsView').classList.remove('show');
                $('fullPlayerOpacitySlider').parentElement.style.display = 'flex';
                setTimeout(() => $('lyricsView').style.display = 'none', 300);
            }

            // 触摸事件（仅限封面区域）
            const coverArea = document.querySelector('.full-player-cover');
            if(coverArea) {
                coverArea.addEventListener('touchstart', e => {
                    touchStartX = e.touches[0].clientX;
                });
                coverArea.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].clientX;
                    const diff = touchStartX - touchEndX;
                    if (diff > 50 && window.innerWidth < 768) { // 左滑超过50px且仅限手机端
                        showLyrics();
                    }
                });
            }

            // 鼠标事件（仅限封面区域）
            if(coverArea) {
                coverArea.addEventListener('mousedown', e => {
                    mouseStartX = e.clientX;
                    isDragging = true;
                });
                coverArea.addEventListener('mouseup', e => {
                    if (isDragging && window.innerWidth < 768) {
                        const diff = mouseStartX - e.clientX;
                        if (diff > 50) { // 左滑超过50px且仅限手机端
                            showLyrics();
                        }
                        isDragging = false;
                    }
                });
                coverArea.addEventListener('mouseleave', () => {
                    isDragging = false;
                });
            }

            // 歌词界面播放按钮
            $('lyricsPlayBtn').addEventListener('click', async(e) => {
                if (!state.current) return;
                if(state.current.url){
                    if (dom.audio.paused) {
                        dom.audio.play();
                        state.playing = true;
                    } else {
                        dom.audio.pause();
                        state.playing = false;
                    }
                    updateUI();
                    $('lyricsPlayBtn').innerHTML = state.playing ? '<i data-lucide="pause"></i>' : '<i data-lucide="play"></i>';
                    renderIconsOptimized();
                }else{
                    await playTrack(state.current,e.target);
                }
            });
            function closeFullPlayer(){
                dom.fullPlayerMask.classList.remove('show');
                dom.fullPlayerPanel.classList.remove('show');
                hideLyrics();
                $('volumePanel').style.display='none';
                $('playlistView').style.display='none';
                $('fullPlayerOpacitySlider').parentElement.style.display='flex';
            }

            // 键盘快捷键
            document.addEventListener('keydown',e=>{
                const tag=document.activeElement.tagName.toLowerCase();
                const typing=(tag==='input'||tag==='textarea');
                if(e.code==='Space'&&!typing){e.preventDefault();if(dom.playPauseBtn)dom.playPauseBtn.click();}
                if(e.key==='ArrowRight'&&!typing){dom.audio.currentTime=(dom.audio.currentTime||0)+5;}
                if(e.key==='ArrowLeft'&&!typing){dom.audio.currentTime=Math.max(0,(dom.audio.currentTime||0)-5);}
                if(e.key==='ArrowUp'&&!typing){dom.audio.volume=Math.min(1,(dom.audio.volume||0)+0.05);if($('volumeSlider'))$('volumeSlider').value=dom.audio.volume;updateVolumeDisplay();}
                if(e.key==='ArrowDown'&&!typing){dom.audio.volume=Math.max(0,(dom.audio.volume||0)-0.05);if($('volumeSlider'))$('volumeSlider').value=dom.audio.volume;updateVolumeDisplay();}
                if((e.key==='n'||e.key==='N')&&!typing)nextTrack('next');
                if((e.key==='p'||e.key==='P')&&!typing)nextTrack('prev');
                if((e.key==='f'||e.key==='F')&&!typing)toggleFav();
                if((e.key==='m'||e.key==='M')&&!typing){state.muted=!state.muted;dom.audio.muted=state.muted;toast(state.muted?'已静音':'已取消静音');}
                if((e.key==='d'||e.key==='D')&&!typing)downloadTrack(state.current);
                if(e.key==='/'&&!typing){e.preventDefault();dom.searchInput.focus();dom.searchInput.select();}
            });

            // 监听窗口大小变化
            window.addEventListener('resize', () => {
                renderInlineLyrics();
            });

            // 歌词区域鼠标滚动支持
            const lyricsContainer = document.querySelector('.lyrics-container');
            if(lyricsContainer) {
                lyricsContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    lyricsContainer.scrollTop += e.deltaY;
                });
            }

            // 初始化
            loadData();
            Object.keys(state.enabledSources).forEach(src=>{
                const cb=document.querySelector(`[data-src="${src}"]`);
                if(cb)cb.checked=state.enabledSources[src];
            });
            $('limitSelect').value=state.perLimit;
            $('qualitySelect').value=state.quality;
            dom.audio.volume=state.volume;
            $('fullMuteBtn').innerHTML=state.muted?'<i data-lucide="volume-x"></i>':'<i data-lucide="volume-2"></i>';
            updateModeUI();

            // 初始化图标一次
            if(typeof lucide !== 'undefined'){
                lucide.createIcons();
            }

            loadDefault();
        }

        // 缓存DOM元素引用
        const progressElements = {
            bar: null,
            handle: null,
            fullBar: null,
            fullHandle: null,
            currentTime: null,
            totalTime: null
        };

        // 分离的进度条更新函数
        function updateProgressBars() {
            const cur = dom.audio.currentTime || 0;
            const dur = dom.audio.duration || 0;
            const r = dur ? cur / dur : 0;

            // 使用transform替代left属性，避免重排
            if (progressElements.bar) {
                progressElements.bar.style.transform = `scaleX(${r})`;
            }
            if (progressElements.handle) {
                const w = dom.progressWrapper.clientWidth;
                progressElements.handle.style.transform = `translateY(-50%) translateX(${w * r - 6}px)`;
            }
            if (progressElements.fullBar) {
                progressElements.fullBar.style.transform = `scaleX(${r})`;
            }
            if (progressElements.fullHandle) {
                const fw = dom.fullProgressWrapper.clientWidth;
                progressElements.fullHandle.style.transform = `translateY(-50%) translateX(${fw * r - 8}px)`;
            }
        }

        // 分离的时间显示更新函数
        function updateTimeDisplay() {
            const cur = dom.audio.currentTime || 0;
            const dur = dom.audio.duration || 0;

            if (progressElements.currentTime) {
                progressElements.currentTime.textContent = fmt(cur);
            }
            if (progressElements.totalTime) {
                progressElements.totalTime.textContent = fmt(dur);
            }
        }

        // 优化的图标渲染函数
        let iconRenderTimeout;
        function renderIconsOptimized() {
            if (iconRenderTimeout) clearTimeout(iconRenderTimeout);
            iconRenderTimeout = setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    // 只渲染新添加的图标，而不是全部重新渲染
                    const newIcons = document.querySelectorAll('i[data-lucide]:not([data-rendered])');
                    if (newIcons.length > 0) {
                        lucide.createIcons();
                        newIcons.forEach(icon => icon.setAttribute('data-rendered', 'true'));
                    }
                }
            }, 16); // 使用requestAnimationFrame的频率
        }

        document.addEventListener('DOMContentLoaded',()=>{
            setup();
            // 初始化时一次性渲染所有图标
            if(typeof lucide !== 'undefined'){
                lucide.createIcons();
                // 标记所有初始图标为已渲染
                document.querySelectorAll('i[data-lucide]').forEach(icon => {
                    icon.setAttribute('data-rendered', 'true');
                });
            }
        });
    })();
</script>
</body>
</html>
