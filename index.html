<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å¢¨ç™½éŸ³ä¹ç›’</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <style>
        :root{
            --bg:linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --panel:rgba(0,0,0,0.3);
            --accent:#ff6b6b;
            --text-main:#ffffff;
            --text-sub:rgba(255,255,255,0.7);
            --border:rgba(255,255,255,0.1);
            --glass:rgba(0,0,0,0.2);
        }
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text-main);font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB",Microsoft YaHei,sans-serif;overflow:hidden;}
        #app{display:flex;flex-direction:column;height:100%;max-width:540px;margin:0 auto;background:transparent;backdrop-filter:blur(20px);border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,0.3);}

        /* é¡¶éƒ¨å¯¼èˆª */
        .topbar{flex-shrink:0;height:40px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--panel);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);border-radius:20px 20px 0 0;}
        .topbar .logo{font-size:18px;font-weight:700;letter-spacing:.5px;color:var(--accent);text-shadow:0 0 10px rgba(255,107,107,0.5);}
        .topbar .author{font-size:12px;color:var(--text-sub);}

        /* ç‰ˆæƒå£°æ˜ */
        .copyright{flex-shrink:0;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);font-size:11px;color:var(--text-sub);text-align:center;display:flex;align-items:center;justify-content:center;gap:8px;}
        .disclaimer-btn{padding:4px 8px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.1);color:var(--text-sub);font-size:10px;cursor:pointer;}

        /* å…è´£å£°æ˜å¼¹çª— */
        .disclaimer-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center;}
        .disclaimer-content{background:var(--panel);border-radius:16px;padding:20px;margin:20px;max-width:400px;backdrop-filter:blur(20px);border:1px solid var(--border);}
        .disclaimer-title{font-size:16px;font-weight:600;color:var(--accent);margin-bottom:16px;text-align:center;}
        .disclaimer-text{font-size:13px;line-height:1.6;color:var(--text-main);margin-bottom:16px;}
        .disclaimer-close{width:100%;padding:8px;border:none;border-radius:8px;background:var(--accent);color:#000;font-size:14px;cursor:pointer;}

        /* æœç´¢æ  */
        .searchbar{flex-shrink:0;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);}
        .searchbar .search{position:relative;}
        .searchbar .search input{width:100%;height:32px;border-radius:20px;border:none;background:rgba(255,255,255,.15);color:var(--text-main);padding:0 32px 0 12px;font-size:14px;outline:none;backdrop-filter:blur(10px);}
        .searchbar .search .icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text-sub);cursor:pointer;}
        .searchbar .search .loading{position:absolute;right:36px;top:50%;transform:translateY(-50%);width:14px;height:14px;border:2px solid transparent;border-top:2px solid var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:none;}
        @keyframes spin{to{transform:translateY(-50%) rotate(360deg);}}

        /* æœç´¢å†å² */
        .search-history{flex-shrink:0;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);display:none;}
        .search-history.show{display:block;}
        .search-history-btn{margin:4px 8px 4px 0;padding:4px 12px;border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.1);color:var(--text-main);font-size:12px;cursor:pointer;}

        /* æ¥æºé€‰æ‹©æ¡ */
        .sourcebar{flex-shrink:0;display:flex;gap:8px;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);font-size:12px;color:var(--text-sub);justify-content:space-between;align-items:center;}
        .sourcebar .sources{display:flex;gap:8px;}
        .sourcebar label{display:flex;align-items:center;gap:4px;}
        .sourcebar input{margin:0;width:12px;height:12px;accent-color:var(--accent);}

        /* è®¾ç½®é€‰é¡¹æ¡ */
        .settingsbar{flex-shrink:0;display:flex;gap:16px;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);font-size:12px;color:var(--text-sub);justify-content:center;align-items:center;}
        .settingsbar .limit-wrapper{display:flex;align-items:center;gap:6px;}
        .settingsbar .quality-wrapper{display:flex;align-items:center;gap:6px;}
        .settingsbar select{background:#000;color:var(--text-main);border:1px solid var(--border);border-radius:8px;padding:3px 6px;font-size:11px;outline:none;}
        .sourcebar select option[value="standard"]{color:#4caf50;}
        .sourcebar select option[value="high"]{color:#4dd0e1;}
        .sourcebar select option[value="lossless"]{color:#ffb74d;}

        /* ä¸­é—´å†…å®¹åŒº */
        .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
        .tabs{flex-shrink:0;display:flex;justify-content:space-around;padding:8px 0;border-bottom:1px solid var(--border);}
        .tabs .tab{padding:6px 14px;font-size:14px;color:var(--text-sub);position:relative;}
        .tabs .tab.active{color:var(--accent);}
        .tabs .tab.active::after{content:"";position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:20px;height:3px;background:var(--accent);border-radius:2px;}
        .scroll{flex:1;overflow-y:auto;padding:12px 16px;}
        .scroll::-webkit-scrollbar{width:0;}

        /* æ­Œæ›²åˆ—è¡¨é¡¹ */
        .track{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);}
        .track .index{width:28px;text-align:center;font-size:12px;color:var(--text-sub);}
        .track .cover{width:48px;height:48px;border-radius:6px;margin-right:12px;background:rgba(255,255,255,.08);object-fit:cover;}
        .track .info{flex:1;min-width:0;}
        .track .title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .track .artist{font-size:12px;color:var(--text-sub);margin-top:2px;display:flex;align-items:center;gap:4px;}
        .track .source-tag{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,.1);}
        .track .source-migu{color:#ffb74d;}
        .track .source-netease{color:#ff6b6b;}
        .track .source-qq{color:#4dd0e1;}
        .track .source-kuwo{color:#ba68c8;}
        .track .playbtn{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:16px;display:flex;align-items:center;justify-content:center;margin-left:8px;}
        .track.playing .playbtn{background:#fff;color:var(--accent);}

        /* åº•éƒ¨æ’­æ”¾å™¨ - ç®€åŒ–ç‰ˆ */
        .player{flex-shrink:0;height:64px;background:var(--panel);border-top:1px solid var(--border);display:none;align-items:center;padding:8px 16px;position:relative;backdrop-filter:blur(30px);border-radius:0 0 20px 20px;}
        .player.show{display:flex;}
        .player .cover-wrapper{position:relative;margin-right:12px;}
        .player .cover{width:48px;height:48px;border-radius:12px;background:rgba(255,255,255,.1);object-fit:cover;box-shadow:0 4px 16px rgba(0,0,0,.2);}
        .player .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3);border-radius:12px;opacity:0;transition:opacity .2s;cursor:pointer;}
        .player .play-overlay:hover{opacity:1;}
        .player .play-overlay button{width:24px;height:24px;border-radius:50%;border:none;background:var(--accent);color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(255,107,107,0.4);}
        .player .info{flex:1;min-width:0;margin-right:12px;}
        .player .title{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;}
        .player .artist{font-size:12px;color:var(--text-sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:4px;}
        .player .quality-tag{font-size:10px;padding:1px 4px;border-radius:3px;background:rgba(0,0,0,.5);}
        .player .quality-standard{color:#4caf50;}
        .player .quality-high{color:#4dd0e1;}
        .player .quality-lossless{color:#ffb74d;}
        .player .controls{display:flex;align-items:center;gap:8px;}
        .player .controls button{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,255,255,.1);color:var(--text-main);font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
        .player .controls button:active{transform:scale(0.95);}
        .player .menu-btn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.1);color:var(--text-sub);font-size:16px;margin-left:8px;border:none;display:flex;align-items:center;justify-content:center;}

        /* è¿›åº¦æ¡ */
        .progress{position:absolute;left:0;right:0;top:0;height:3px;background:rgba(255,255,255,.1);cursor:pointer;}
        .progress .bar{height:100%;background:linear-gradient(90deg,var(--accent),#ff6b6b);transform-origin:left;transform:scaleX(0);border-radius:0 2px 2px 0;}
        .progress .handle{position:absolute;top:50%;transform:translateY(-50%);width:12px;height:12px;background:var(--accent);border-radius:50%;left:0;box-shadow:0 2px 6px rgba(255,205,50,.5);opacity:0;transition:opacity .2s;}
        .progress:hover .handle{opacity:1;}

        /* å…¨å±æ’­æ”¾å™¨é¢æ¿ */
        .full-player-panel{
            position:fixed;
            inset:0;
            background:linear-gradient(135deg,rgba(26,26,46,0.5),rgba(26,31,58,0.5));
            display:flex;
            flex-direction:column;
            transform:translateY(100%);
            transition:transform .4s cubic-bezier(.4,0,.2,1);
            z-index:102;
        }
        .full-player-panel.show{
            transform:translateY(0);
        }
        .full-player-opacity-control{
            position:absolute;
            top:20px;
            right:20px;
            display:flex;
            align-items:center;
            gap:8px;
            z-index:104;
        }
        .lyrics-view.show ~ .full-player-opacity-control,
        .playlist-view[style*="flex"] ~ .full-player-opacity-control{
            display:none;
        }
        .full-opacity-slider{
            width:80px;
            height:4px;
            background:rgba(255,255,255,.2);
            border-radius:2px;
            outline:none;
            -webkit-appearance:none;
        }
        .full-opacity-slider::-webkit-slider-thumb{
            width:12px;
            height:12px;
            background:var(--accent);
            border-radius:50%;
            -webkit-appearance:none;
            cursor:pointer;
        }
        .full-player-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 20px;
            height:56px;
        }
        .close-btn{
            width:40px;
            height:40px;
            border-radius:50%;
            background:rgba(255,255,255,.1);
            border:none;
            color:var(--text-main);
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .full-player-song-info{
            text-align:center;
            padding:0 24px;
            margin-bottom:16px;
        }
        .full-player-song-info .full-title{
            font-size:18px;
            font-weight:600;
            margin-bottom:6px;
        }
        .full-player-song-info .full-artist{
            font-size:14px;
            color:var(--text-sub);
            display:flex;
            align-items:center;
            justify-content:center;
            gap:6px;
        }
        .full-quality-tag{
            font-size:11px;
            padding:2px 6px;
            border-radius:4px;
            background:rgba(0,0,0,.6);
        }
        .full-quality-standard{color:#4caf50;}
        .full-quality-high{color:#4dd0e1;}
        .full-quality-lossless{color:#ffb74d;}
        .full-player-cover{
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:40px;
        }

        @media (min-width: 768px) {
            .full-player-cover {
                justify-content: center;
                gap: 64px;
            }
            .cover-lyrics-container {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 20px;
                width: 100%;
                max-width: none;
            }
            .cover-container {
                flex: 0 0 30%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            .lyrics-container {
                flex: 0 0 30%;
                max-height: 400px;
                overflow-y: auto;
                padding: 30px 20px;
                background: transparent;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .lyrics-container::-webkit-scrollbar {
                width: 0;
            }
            .full-player-song-info {
                display: none;
            }
            .pc-song-info {
                text-align: center;
                margin-top: 20px;
                display: block;
            }
            .pc-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 6px;
            }
            .pc-artist {
                font-size: 14px;
                color: var(--text-sub);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }
            .inline-lyrics {
                text-align: center;
                font-size: 20px;
                line-height: 2.5;
                color: var(--text-sub);
                width: 100%;
            }
            .inline-lyrics div {
                transition: all .35s cubic-bezier(.4,0,.2,1);
                margin: 8px 0;
            }
            .inline-lyrics .active {
                color: var(--accent);
                font-size: 26px;
                font-weight: 700;
                text-shadow: 0 0 15px rgba(255,205,50,.55);
                transform: scale(1.05);
            }
        }
        .rotating-cover{
            width:280px;
            height:280px;
            border-radius:50%;
            object-fit:cover;
            background:rgba(255,255,255,.1);
            animation:rotate 20s linear infinite;
            box-shadow:0 8px 32px rgba(0,0,0,.4);
        }
        .rotating-cover.paused{
            animation-play-state:paused;
        }
        @keyframes rotate{
            from{transform:rotate(0deg);}
            to{transform:rotate(360deg);}
        }
        .full-player-progress{
            display:flex;
            align-items:center;
            padding:0 24px;
            margin-bottom:32px;
        }
        .time{
            font-size:12px;
            color:var(--text-sub);
            width:40px;
            text-align:center;
        }
        .full-progress{
            flex:1;
            height:4px;
            background:rgba(255,255,255,.2);
            border-radius:2px;
            margin:0 12px;
            position:relative;
            cursor:pointer;
        }
        .full-bar{
            height:100%;
            background:linear-gradient(90deg,var(--accent),#ff6b6b);
            border-radius:2px;
            transform-origin:left;
            transform:scaleX(0);
        }
        .full-handle{
            position:absolute;
            top:50%;
            transform:translateY(-50%);
            width:16px;
            height:16px;
            background:var(--accent);
            border-radius:50%;
            left:0;
            box-shadow:0 2px 8px rgba(255,205,50,.6);
        }
        .full-player-controls{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:24px;
            padding:0 24px;
            margin-bottom:24px;
        }
        .control-btn{
            width:56px;
            height:56px;
            border-radius:50%;
            border:none;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:24px;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .2s;
        }
        .control-btn:active{
            transform:scale(0.95);
        }
        .play-btn{
            width:72px;
            height:72px;
            background:var(--accent);
            color:#000;
            font-size:32px;
            box-shadow:0 4px 16px rgba(255,205,50,.4);
        }
        .full-player-actions{
            display:flex;
            align-items:center;
            justify-content:space-around;
            padding:0 40px 24px;
        }
        .action-btn{
            width:48px;
            height:48px;
            border-radius:50%;
            border:none;
            background:rgba(255,255,255,.08);
            color:var(--text-sub);
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .lyrics-play-btn{
            position:fixed;
            bottom:30px;
            right:30px;
            width:56px;
            height:56px;
            border-radius:50%;
            border:none;
            background:var(--accent);
            color:#000;
            font-size:24px;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 4px 16px rgba(255,107,107,0.4);
            z-index:105;
        }

        /* æ’­æ”¾åˆ—è¡¨è§†å›¾ */
        .playlist-view{
            position:absolute;
            inset:0;
            background:rgba(26,26,46,0.9);
            display:flex;
            flex-direction:column;
            z-index:103;
            backdrop-filter:blur(10px);
        }
        .playlist-controls{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 20px;
            border-bottom:1px solid var(--border);
        }
        .playlist-mode-btn{
            width:40px;
            height:40px;
            border-radius:50%;
            border:none;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:16px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .playlist-batch-controls{
            display:none;
            align-items:center;
            gap:8px;
        }
        .playlist-batch-controls.show{
            display:flex;
        }
        .batch-btn{
            padding:6px 12px;
            border:1px solid var(--border);
            border-radius:16px;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:12px;
            cursor:pointer;
        }
        .playlist-opacity-control{
            position:absolute;
            top:70px;
            right:20px;
            display:none;
            align-items:center;
            gap:8px;
            z-index:104;
        }
        .opacity-slider{
            width:80px;
            height:4px;
            background:rgba(255,255,255,.2);
            border-radius:2px;
            outline:none;
            -webkit-appearance:none;
        }
        .opacity-slider::-webkit-slider-thumb{
            width:12px;
            height:12px;
            background:var(--accent);
            border-radius:50%;
            -webkit-appearance:none;
            cursor:pointer;
        }
        .playlist-scroll{
            flex:1;
            overflow-y:auto;
            padding:0;
        }
        .playlist-item{
            display:flex;
            align-items:center;
            padding:12px 20px;
            border-bottom:1px solid var(--border);
            cursor:pointer;
        }
        .playlist-item:hover{
            background:rgba(255,255,255,.05);
        }
        .playlist-item.active{
            background:rgba(255,107,107,.1);
        }
        .playlist-item .checkbox{
            width:20px;
            height:20px;
            margin-right:12px;
            accent-color:var(--accent);
            display:none;
        }
        .playlist-item.batch-mode .checkbox{
            display:block;
        }
        .playlist-item .index{
            width:24px;
            font-size:12px;
            color:var(--text-sub);
        }
        .playlist-item.batch-mode .index{
            display:none;
        }
        .playlist-item .info{
            flex:1;
            margin-left:12px;
        }
        .playlist-item .title{
            font-size:14px;
            margin-bottom:2px;
        }
        .playlist-item .artist{
            font-size:12px;
            color:var(--text-sub);
        }


        /* æ­Œè¯è§†å›¾ */
        .lyrics-view{
            position:absolute;
            inset:0;
            background:var(--bg);
            display:flex;
            flex-direction:column;
            z-index:103;
            transform:translateX(100%);
            transition:transform .3s cubic-bezier(.4,0,.2,1);
        }
        .lyrics-view.show{
            transform:translateX(0);
        }
        .lyrics-scroll-full{
            flex:1;
            overflow-y:auto;
            padding:20px;
            text-align:center;
            font-size:18px;
            line-height:2.5;
            color:var(--text-sub);
            scroll-behavior:smooth;
        }
        .lyrics-scroll-full::-webkit-scrollbar {
            width: 6px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .lyrics-scroll-full:hover::-webkit-scrollbar {
            opacity: 1;
        }
        .lyrics-scroll-full::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        .lyrics-scroll-full::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        .lyrics-scroll-full::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
        .lyrics-scroll-full div{
            transition:all .35s cubic-bezier(.4,0,.2,1);
            margin:8px 0;
        }
        .lyrics-scroll-full .active{
            color:var(--accent);
            font-size:22px;
            font-weight:700;
            text-shadow:0 0 15px rgba(255,205,50,.55);
            transform:scale(1.05);
        }
        .lyrics-scroll-full.alt-style{
            background:linear-gradient(135deg,rgba(255,205,50,.1),rgba(255,105,180,.1));
            border-radius:12px;
            padding:20px;
        }
        .lyrics-scroll-full.alt-style .active{
            color:#ff69b4;
            text-shadow:0 0 20px rgba(255,105,180,.8);
            font-size:30px;
        }
        .lyrics-controls{
            display:flex;
            justify-content:center;
            gap:16px;
            padding:16px 24px 24px;
        }
        .lyrics-btn{
            padding:8px 16px;
            border:1px solid var(--border);
            border-radius:20px;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:14px;
        }

        /* éŸ³é‡æ§åˆ¶é¢æ¿ */
        .volume-panel{
            position:absolute;
            inset:0;
            background:var(--bg);
            display:flex;
            flex-direction:column;
            z-index:103;
        }
        .volume-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 20px;
            height:56px;
        }
        .volume-title{
            font-size:16px;
            font-weight:600;
        }
        .volume-content{
            flex:1;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:40px;
        }
        .volume-display{
            font-size:48px;
            font-weight:700;
            color:var(--accent);
            margin-bottom:40px;
        }
        .volume-slider-full{
            width:80%;
            height:6px;
            background:rgba(255,255,255,.2);
            border-radius:3px;
            outline:none;
            -webkit-appearance:none;
            margin-bottom:40px;
        }
        .volume-slider-full::-webkit-slider-thumb{
            width:24px;
            height:24px;
            background:var(--accent);
            border-radius:50%;
            -webkit-appearance:none;
            cursor:pointer;
            box-shadow:0 2px 8px rgba(255,205,50,.4);
        }
        .volume-buttons{
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            justify-content:center;
        }
        .volume-btn,.volume-preset{
            padding:8px 16px;
            border:1px solid var(--border);
            border-radius:20px;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:14px;
        }

        /* PCç«¯æ­Œæ›²ä¿¡æ¯ */
        .pc-song-info {
            display: none;
        }
        @media (min-width: 768px) {
            .pc-song-info {
                display: block;
                text-align: center;
                margin-top: 20px;
            }
            .pc-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 6px;
            }
            .pc-artist {
                font-size: 14px;
                color: var(--text-sub);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }
        }
        .lyrics-mask{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.55);
            z-index:100;
            display:none;
            opacity:0;
            transition:opacity .3s cubic-bezier(.4,0,.2,1);
        }
        .lyrics-mask.show{
            display:block;
            opacity:1;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- é¡¶éƒ¨ -->
    <header class="topbar">
        <div class="logo">å¢¨ç™½éŸ³ä¹ç›’</div>
        <div class="author">QQ: 37010871</div>
    </header>

    <!-- ç‰ˆæƒå£°æ˜ -->
    <div class="copyright">
        <span>æœ¬ç«™ä»…ä½œä¸ºå­¦ä¹ æ¼”ç¤ºï¼ŒéŸ³ä¹ç‰ˆæƒå½’å„å¹³å°ä¸åŸä½œè€…æ‰€æœ‰ã€‚</span>
        <button class="disclaimer-btn" id="disclaimerBtn">å…è´£å£°æ˜</button>
    </div>

    <!-- æ¥æºé€‰æ‹© -->
    <div class="sourcebar">
        <div class="sources">
            <label><input type="checkbox" data-src="migu">å’ªå’•</label>
            <label><input type="checkbox" data-src="netease" checked>ç½‘æ˜“äº‘</label>
            <label><input type="checkbox" data-src="qq">QQ</label>
            <label><input type="checkbox" data-src="kuwo">é…·æˆ‘</label>
        </div>
    </div>

    <!-- è®¾ç½®é€‰é¡¹ -->
    <div class="settingsbar">
        <div class="limit-wrapper">
            <span>æ•°é‡:</span>
            <select id="limitSelect">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="30">30</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
        <div class="quality-wrapper">
            <span>éŸ³è´¨:</span>
            <select id="qualitySelect">
                <option value="standard">æ ‡å‡†</option>
                <option value="high" selected>é«˜å“è´¨</option>
                <option value="lossless">æ— æŸ</option>
            </select>
        </div>
    </div>

    <!-- æœç´¢æ  -->
    <div class="searchbar">
        <div class="search">
            <input id="searchInput" placeholder="æœç´¢éŸ³ä¹ã€æ­Œæ‰‹">
            <span class="loading" id="loading"></span>
            <span class="icon" id="searchIcon">ğŸ”</span>
        </div>
    </div>

    <!-- æœç´¢å†å² -->
    <div id="searchHistory" class="search-history"></div>

    <!-- ä¸­é—´ -->
    <main class="main">
        <nav class="tabs">
            <div class="tab active" data-tab="results">æœç´¢</div>
            <div class="tab" data-tab="favorites">æ”¶è—</div>
            <div class="tab" data-tab="playlists">å†å²</div>
        </nav>
        <div id="scroll" class="scroll"></div>
    </main>

    <!-- åº•éƒ¨æ’­æ”¾å™¨ - ç®€åŒ–ç‰ˆ -->
    <footer class="player" id="player">
        <div id="progressWrapper" class="progress">
            <div id="progressBar" class="bar"></div>
            <div id="progressHandle" class="handle"></div>
        </div>
        <div class="cover-wrapper">
            <img id="cover" class="cover" style="display:none">
        </div>
        <div class="info">
            <div id="title" class="title">æš‚æœªé€‰æ‹©æ­Œæ›²</div>
            <div id="artist" class="artist">ç‚¹å‡»é€‰æ‹©éŸ³ä¹</div>
        </div>
        <div class="controls">
            <button id="playPauseBtn">â–¶</button>
            <button id="nextBtn">â­</button>
            <button id="favBtn">â¤</button>
        </div>
        <button id="menuBtn" class="menu-btn">â‹¯</button>
    </footer>
</div>

<!-- å…¨å±æ’­æ”¾å™¨é¢æ¿ -->
<div id="fullPlayerMask" class="lyrics-mask"></div>
<div id="fullPlayerPanel" class="full-player-panel">
    <div class="full-player-opacity-control">
        <span style="font-size:12px;color:var(--text-sub);">é€æ˜åº¦</span>
        <input id="fullPlayerOpacitySlider" class="full-opacity-slider" type="range" min="0.3" max="1" step="0.1" value="0.5">
    </div>
    <div class="full-player-header">
        <button id="fullPlayerClose" class="close-btn">â†“</button>
        <div style="width:40px;"></div>
        <div style="width:40px;"></div>
    </div>
    <div class="full-player-cover">
        <div class="cover-lyrics-container">
            <div class="cover-container">
                <img id="fullCover" class="rotating-cover" src="">
                <div class="pc-song-info">
                    <div id="fullTitlePC" class="pc-title">--</div>
                    <div id="fullArtistPC" class="pc-artist">--</div>
                </div>
            </div>
            <div class="lyrics-container" style="display:none;">
                <div id="inlineLyrics" class="inline-lyrics"></div>
            </div>
        </div>
    </div>
    <div class="full-player-song-info">
        <div id="fullTitle" class="full-title">--</div>
        <div id="fullArtist" class="full-artist">--</div>
    </div>
    <div class="full-player-progress">
        <span id="currentTime" class="time">00:00</span>
        <div id="fullProgressWrapper" class="full-progress">
            <div id="fullProgressBar" class="full-bar"></div>
            <div id="fullProgressHandle" class="full-handle"></div>
        </div>
        <span id="totalTime" class="time">00:00</span>
    </div>
    <div class="full-player-controls">
        <button id="fullModeBtn" class="control-btn">ğŸ”</button>
        <button id="fullPrevBtn" class="control-btn">â®</button>
        <button id="fullPlayBtn" class="control-btn play-btn">â–¶</button>
        <button id="fullNextBtn" class="control-btn">â­</button>
        <button id="fullFavBtn" class="control-btn">â¤</button>
    </div>
    <div class="full-player-actions">
        <button id="fullDownloadBtn" class="action-btn">â¬‡</button>
        <button id="fullLyricsBtn" class="action-btn">è¯</button>
        <button id="fullMuteBtn" class="action-btn">ğŸ”Š</button>
        <button id="fullListBtn" class="action-btn">â˜°</button>
    </div>

    <!-- æ­Œè¯è§†å›¾ -->
    <div id="lyricsView" class="lyrics-view" style="display:none;">
        <div class="full-player-header">
            <button id="lyricsBackBtn" class="close-btn">â†</button>
            <div class="song-info">
                <div id="lyricsTitle" class="full-title">--</div>
                <div id="lyricsArtist" class="full-artist">--</div>
            </div>
            <button id="lyricsStyleBtn" class="close-btn">ğŸ¨</button>
        </div>
        <div id="lyricsScroll" class="lyrics-scroll-full"></div>
        <div class="lyrics-controls">
            <button id="jumpPrev" class="lyrics-btn">ä¸Šä¸€å¥</button>
            <button id="jumpNext" class="lyrics-btn">ä¸‹ä¸€å¥</button>
        </div>
        <button id="lyricsPlayBtn" class="lyrics-play-btn">â–¶</button>
    </div>

    <!-- éŸ³é‡æ§åˆ¶é¢æ¿ -->
    <div id="volumePanel" class="volume-panel" style="display:none;">
        <div class="volume-header">
            <button id="volumeBackBtn" class="close-btn">â†</button>
            <div class="volume-title">éŸ³é‡æ§åˆ¶</div>
            <div style="width:40px;"></div>
        </div>
        <div class="volume-content">
            <div class="volume-display">
                <span id="volumeValue">70</span>%
            </div>
            <input id="volumeSlider" class="volume-slider-full" type="range" min="0" max="1" step="0.01" value="0.7">
            <div class="volume-buttons">
                <button id="muteBtn" class="volume-btn">ğŸ”Š</button>
                <button class="volume-preset" data-volume="0.3">30%</button>
                <button class="volume-preset" data-volume="0.5">50%</button>
                <button class="volume-preset" data-volume="0.7">70%</button>
                <button class="volume-preset" data-volume="1.0">100%</button>
            </div>
        </div>
    </div>

    <!-- æ’­æ”¾åˆ—è¡¨è§†å›¾ -->
    <div id="playlistView" class="playlist-view" style="display:none;">
        <div class="full-player-header">
            <button id="playlistBackBtn" class="close-btn">â†</button>
            <div class="song-info">
                <div class="full-title">æ’­æ”¾åˆ—è¡¨</div>
            </div>
            <div style="width:40px;"></div>
        </div>
        <div class="playlist-controls">
            <button id="playlistModeBtn" class="playlist-mode-btn">ğŸ”</button>
            <div class="playlist-batch-controls">
                <button id="selectAllBtn" class="batch-btn">å…¨é€‰</button>
                <button id="batchDownloadBtn" class="batch-btn">ä¸‹è½½</button>
                <button id="cancelBatchBtn" class="batch-btn">å–æ¶ˆ</button>
            </div>
            <button id="batchModeBtn" class="playlist-mode-btn">â¬‡</button>
        </div>
        <div class="playlist-opacity-control">
            <span style="font-size:12px;color:var(--text-sub);">é€æ˜åº¦</span>
            <input id="playlistOpacitySlider" class="opacity-slider" type="range" min="0.3" max="1" step="0.1" value="0.9">
        </div>
        <div id="playlistScroll" class="playlist-scroll"></div>
    </div>
</div>

<!-- å…è´£å£°æ˜å¼¹çª— -->
<div id="disclaimerModal" class="disclaimer-modal">
    <div class="disclaimer-content">
        <div class="disclaimer-title">å…è´£å£°æ˜</div>
        <div class="disclaimer-text">
            æœ¬ç«™æ‰€æœ‰æ•°æ®å‡ç³»ç½‘å‹æœé›†è‡ªäº’è”ç½‘ååˆ†äº«ï¼Œä»…ä¾›éŸ³ä¹çˆ±å¥½è€…äº¤æµä½¿ç”¨ã€‚<br><br>
            éŸ³é¢‘ç‰ˆæƒå½’åŸç½‘ç«™åŠç‰ˆæƒæ–¹æ‰€æœ‰ï¼Œæœ¬ç«™ä¸æä¾›ä»»ä½•éŸ³é¢‘å­˜å‚¨å’Œè´©å–æœåŠ¡ï¼Œæ”¯æŒè´­ä¹°æ­£ç‰ˆéŸ³ä¹ã€‚<br><br>
            å¦‚å†…å®¹ä¾µçŠ¯æ‚¨çš„æƒç›Šï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬åˆ é™¤ï¼š<br><br>
            QQ: 37010871
        </div>
        <button class="disclaimer-close" id="disclaimerClose">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<!-- éŸ³é¢‘ -->
<audio id="audio" preload="metadata"></audio>

<script>
    (function(){
        const state={
            enabledSources:{migu:false,netease:true,qq:false,kuwo:false},
            perLimit:20,
            keyword:'',
            results:[],
            favorites:[],
            playlists:[],
            history:[],
            searchHistory:[],
            current:null,
            playing:false,
            mode:'list',
            lyrics:[],
            lyricIndex:-1,
            noMore:false,
            isSearching:false,
            volume:0.7,
            muted:false,
            selectedTracks:[],
            batchMode:false,
            quality:'high'
        };

        // æœ¬åœ°å­˜å‚¨
        function saveData(){localStorage.setItem('musicbox',JSON.stringify({favorites:state.favorites,history:state.history,searchHistory:state.searchHistory,enabledSources:state.enabledSources,mode:state.mode,volume:state.volume,quality:state.quality,perLimit:state.perLimit}));}
        function loadData(){try{const d=JSON.parse(localStorage.getItem('musicbox')||'{}');Object.assign(state,d);if(!state.history)state.history=[];if(!state.searchHistory)state.searchHistory=[];if(!state.quality)state.quality='high';if(!state.perLimit)state.perLimit=20;}catch(e){}}
        const dom={};
        function $(id){return document.getElementById(id);}
        function toast(msg){
            const el=document.createElement('div');
            el.style.cssText="position:fixed;left:50%;bottom:60px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:6px 14px;border-radius:14px;font-size:12px;z-index:200";
            el.textContent=msg;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(),1500);
        }
        function fmt(s){
            if(!isFinite(s)||s<0)s=0;
            const m=Math.floor(s/60);
            const sec=Math.floor(s%60);
            return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
        }
        function setLoading(v){$('loading').style.display=v?'block':'none';}

        // åŠ è½½é»˜è®¤ç½‘æ˜“äº‘æ¨è
        async function loadDefault(){
            if(state.keyword) return;
            setLoading(true);
            state.isSearching=true;
            try{
                const url=`https://api-v1.cenguigui.cn/api/music/netease/WyY_Dg.php?type=json&msg=çƒ­æ­Œæ¦œ&num=${state.perLimit}&n=`;
                const res=await fetch(url);
                const j=await res.json();
                if(j.code===200&&Array.isArray(j.data)){
                    j.data.forEach(it=>{
                        const uid=`netease-${it.songid}`;
                        if(state.results.find(t=>t.uid===uid))return;
                        state.results.push({
                            uid,source:'netease',songid:it.songid,
                            title:it.title,singer:it.singer,
                            cover:it.pic||null,url:null,lrc:null,done:false
                        });
                    });
                }
            }catch(e){}
            setLoading(false);
            state.isSearching=false;
            renderList();
            // é»˜è®¤åŠ è½½å®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºç¬¬ä¸€é¦–æ­Œæ›²ä¿¡æ¯
            if(state.results.length > 0) {
                showFirstTrack();
            }
        }

        async function searchAll(reset){
            if(reset){state.results=[];state.noMore=false;}
            const kw=state.keyword.trim();
            if(kw&&!state.searchHistory.includes(kw)){state.searchHistory.unshift(kw);state.searchHistory=state.searchHistory.slice(0,10);saveData();}
            const enabled=Object.keys(state.enabledSources).filter(k=>state.enabledSources[k]);
            if(!enabled.length){toast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¥æº');return;}
            setLoading(true);
            state.isSearching=true;
            const tasks=enabled.map(src=>{
                if(src==='migu')return searchMigu(state.keyword,state.perLimit);
                if(src==='netease')return searchNetease(state.keyword,state.perLimit);
                return searchQQKuwo(state.keyword,state.perLimit,src);
            });
            let added=0;
            try{const res=await Promise.all(tasks);added=res.reduce((a,b)=>a+b,0);}catch(e){toast('æœç´¢å‡ºé”™');}
            setLoading(false);
            state.isSearching=false;
            if(!reset&&added===0){state.noMore=true;toast('æ²¡æœ‰æ›´å¤šäº†');}
            renderList();
            // æœç´¢å®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºç¬¬ä¸€é¦–æ­Œæ›²ä¿¡æ¯
            if(reset && state.results.length > 0) {
                showFirstTrack();
            }
        }
        async function searchMigu(kw,limit){
            const url=`https://api-v1.cenguigui.cn/api/music/mgmusic_lingsheng.php?msg=${encodeURIComponent(kw||'')}&limit=${limit}&n=`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!Array.isArray(j.data))return 0;let added=0;j.data.forEach(it=>{const uid=`migu-${kw||''}-${it.n||0}-${it.title}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:'migu',title:it.title,singer:it.singer,cover:null,url:null,lrc:null,done:false});added++;});return added;
        }
        async function searchNetease(kw,limit){
            const url=`https://api-v1.cenguigui.cn/api/music/netease/WyY_Dg.php?type=json&msg=${encodeURIComponent(kw||'çƒ­æ­Œæ¦œ')}&num=${limit}&n=`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!Array.isArray(j.data))return 0;let added=0;j.data.forEach(it=>{const uid=`netease-${it.songid}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:'netease',songid:it.songid,title:it.title,singer:it.singer,cover:it.pic||null,url:null,lrc:null,done:false});added++;});return added;
        }
        async function searchQQKuwo(kw,limit,src){
            const url=`https://music-dl.sayqz.com/api?type=search&keyword=${encodeURIComponent(kw)}&source=${src}&limit=${limit}`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!j.data||!Array.isArray(j.data.results))return 0;let added=0;j.data.results.forEach(it=>{const uid=`${src}-${it.id}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:src,title:it.name,singer:it.artist,cover:it.pic,url:it.url,lrc:it.lrc,done:!!it.url});added++;});return added;
        }
        async function ensureDetail(track){
            if(track.done&&track.url)return;
            if(track.source==='migu'){const br=state.quality==='lossless'?'1':state.quality==='high'?'2':'3';const url=`https://api-v1.cenguigui.cn/api/mg_music/?msg=${encodeURIComponent(track.title)}&n=1&type=json&br=${br}`;const res=await fetch(url);const j=await res.json();if(j.code===200&&j.data){track.url=j.data.music_url;track.cover=j.data.cover;track.lrc=j.data.lrc_url?await(await fetch(j.data.lrc_url)).text():null;track.done=true;}}
            if(track.source==='netease'){const level=state.quality==='lossless'?'lossless':state.quality==='high'?'exhigh':'standard';const url=`https://api.cenguigui.cn/api/netease/music_v1.php?id=${track.songid}&type=json&level=${level}`;const res=await fetch(url);const j=await res.json();if(j.code===200&&j.data){track.url=j.data.url;track.cover=j.data.pic;track.lrc=j.data.lyric;track.done=true;}}
        }
        function parseLRC(txt){if(!txt)return[];const lines=txt.split(/\r?\n/);const reg=/\[(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?\]/;const out=[];lines.forEach(line=>{const m=reg.exec(line);if(!m)return;const time=parseInt(m[1])*60+parseInt(m[2])+((m[3]?parseInt(m[3].padEnd(3,'0')):0)/1000);const text=line.replace(reg,'').trim();if(text)out.push({time,text});});out.sort((a,b)=>a.time-b.time);return out;}
        function renderSearchHistory(){
            const wrap=$('searchHistory');
            if(state.searchHistory.length){
                wrap.innerHTML='';
                state.searchHistory.forEach(kw=>{
                    const btn=document.createElement('button');
                    btn.className='search-history-btn';
                    btn.textContent=kw;
                    btn.onclick=()=>{$('searchInput').value=kw;state.keyword=kw;searchAll(true);wrap.classList.remove('show');};
                    wrap.appendChild(btn);
                });
                wrap.classList.add('show');
            }else{
                wrap.classList.remove('show');
            }
        }
        function renderList(){
            const wrap=$('scroll');wrap.innerHTML='';const tab=document.querySelector('.tab.active').dataset.tab;let list=[];
            if(tab==='results')list=state.results;
            else if(tab==='favorites')list=state.favorites;
            else if(tab==='playlists'){
                if(state.history.length){
                    const headerDiv=document.createElement('div');
                    headerDiv.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:10px 0;';
                    headerDiv.innerHTML='<span style="color:var(--text-sub);font-size:14px;">æ’­æ”¾å†å²</span><button id="clearHistoryBtn" style="padding:4px 8px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.1);color:var(--text-sub);font-size:12px;cursor:pointer;">æ¸…ç©ºå†å²</button>';
                    wrap.appendChild(headerDiv);
                    state.history.slice(0,20).forEach((tr,idx)=>{
                        const row=document.createElement('div');row.className='track';const srcTag=tr.source==='migu'?'å’ªå’•':tr.source==='netease'?'ç½‘æ˜“äº‘':tr.source==='qq'?'QQ':'é…·æˆ‘';
                        row.innerHTML=`<div class="index">${idx+1}</div><img class="cover" src="${tr.cover||''}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><div class="cover-placeholder" style="width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,rgba(255,205,50,.15),rgba(255,183,77,.15));display:none;margin-right:12px;flex-shrink:0;text-align:center;line-height:48px;color:var(--accent);font-size:22px;box-shadow:0 2px 6px rgba(255,205,50,.2);">ğŸµ</div><div class="info"><div class="title">${tr.title||'Unknown'}</div><div class="artist"><span class="source-tag source-${tr.source}">${srcTag}</span>${tr.singer||''}</div></div><button class="playbtn">â–¶</button>`;
                        row.querySelector('.playbtn').onclick=async(e)=>{window.event=e;await playTrack(tr);};row.onclick=()=>row.querySelector('.playbtn').click();wrap.appendChild(row);
                    });
                    // æ·»åŠ æ¸…ç©ºå†å²æŒ‰é’®äº‹ä»¶
                    const clearBtn=document.getElementById('clearHistoryBtn');
                    if(clearBtn){
                        clearBtn.onclick=()=>{
                            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ’­æ”¾å†å²å—ï¼Ÿ')){
                                state.history=[];
                                saveData();
                                renderList();
                                toast('æ’­æ”¾å†å²å·²æ¸…ç©º');
                            }
                        };
                    }
                }
                if(state.searchHistory.length){
                    const histDiv=document.createElement('div');histDiv.style.cssText='padding:20px 0 10px;color:var(--text-sub);font-size:14px;';histDiv.textContent='æœç´¢å†å²';wrap.appendChild(histDiv);
                    state.searchHistory.forEach(kw=>{
                        const btn=document.createElement('button');btn.style.cssText='margin:4px 8px 4px 0;padding:4px 12px;border:1px solid var(--border);border-radius:16px;background:rgba(255,255,255,.1);color:var(--text-main);font-size:12px;cursor:pointer;';
                        btn.textContent=kw;btn.onclick=()=>{$('searchInput').value=kw;state.keyword=kw;searchAll(true);};wrap.appendChild(btn);
                    });
                }
                return;
            }
            list.forEach((tr,idx)=>{const row=document.createElement('div');row.className='track';const srcTag=tr.source==='migu'?'å’ªå’•':tr.source==='netease'?'ç½‘æ˜“äº‘':tr.source==='qq'?'QQ':'é…·æˆ‘';row.innerHTML=`<div class="index">${idx+1}</div><img class="cover" src="${tr.cover||''}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><div class="cover-placeholder" style="width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,rgba(255,205,50,.15),rgba(255,183,77,.15));display:none;margin-right:12px;flex-shrink:0;text-align:center;line-height:48px;color:var(--accent);font-size:22px;box-shadow:0 2px 6px rgba(255,205,50,.2);">ğŸµ</div><div class="info"><div class="title">${tr.title||'Unknown'}</div><div class="artist"><span class="source-tag source-${tr.source}">${srcTag}</span>${tr.singer||''}</div></div><button class="playbtn">â–¶</button>`;const playBtn=row.querySelector('.playbtn');playBtn.onclick=async(e)=>{e.stopPropagation();if(state.current&&state.current.uid===tr.uid&&state.current.url){if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();}else{await playTrack(tr,playBtn);}};row.onclick=()=>playBtn.click();wrap.appendChild(row);});
        }
        async function playTrack(track, clickedBtn){
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if(clickedBtn) clickedBtn.textContent = '...';

            state.current=track;
            // ç«‹å³æ¸…ç©ºæ­Œè¯çŠ¶æ€
            state.lyrics=[];
            state.lyricIndex=-1;
            $('lyricsScroll').innerHTML='<div style="margin-top:30px;color:var(--text-sub)">åŠ è½½ä¸­...</div>';
            $('inlineLyrics').innerHTML='';

            try {
                await ensureDetail(track);
                if(!track.url){toast('æ’­æ”¾å¤±è´¥');updateUI();return;}

                const histIdx=state.history.findIndex(t=>t.uid===track.uid);
                if(histIdx>=0)state.history.splice(histIdx,1);
                state.history.unshift({...track});
                state.history=state.history.slice(0,50);
                saveData();

                $('audio').src=track.url;
                await $('audio').play();
                state.playing=true;
                updateUI();

                state.lyrics=track.lrc?parseLRC(track.lrc):[];
                renderLyrics();
                renderInlineLyrics();
            } catch(e) {
                toast('æ’­æ”¾å¤±è´¥');
                updateUI();
            }
        }
        function showFirstTrack(){
            if(state.results.length > 0){
                const firstTrack = state.results[0];
                state.current = firstTrack;
                state.playing = false;
                // ä¸é¢„åŠ è½½éŸ³é¢‘è¯¦æƒ…ï¼Œåªæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                updateUI();
            }
        }
        function updateUI(){const tr=state.current;$('title').textContent=tr?tr.title:'æš‚æœªé€‰æ‹©æ­Œæ›²';const artistText=tr?tr.singer:'ç‚¹å‡»é€‰æ‹©éŸ³ä¹';const qualityText=tr?state.quality==='lossless'?'æ— æŸ':state.quality==='high'?'é«˜å“è´¨':'æ ‡å‡†':'';const qualityClass=tr?`quality-${state.quality}`:'';$('artist').innerHTML=tr?`${artistText} <span class="quality-tag ${qualityClass}">${qualityText}</span>`:artistText;if($('fullTitle'))$('fullTitle').textContent=tr?tr.title:'--';if($('fullArtist'))$('fullArtist').innerHTML=tr?`${tr.singer} <span class="full-quality-tag full-${qualityClass}">${qualityText}</span>`:'--';if($('fullTitlePC'))$('fullTitlePC').textContent=tr?tr.title:'--';if($('fullArtistPC'))$('fullArtistPC').innerHTML=tr?`${tr.singer} <span class="full-quality-tag full-${qualityClass}">${qualityText}</span>`:'--';const cover=tr&&tr.cover?tr.cover:'';$('cover').src=cover;$('cover').style.display=tr&&tr.cover?'block':'none';if($('fullCover'))$('fullCover').src=cover||'';$('playPauseBtn').textContent=state.playing?'â¸':'â–¶';if($('fullPlayBtn'))$('fullPlayBtn').textContent=state.playing?'â¸':'â–¶';if($('lyricsPlayBtn'))$('lyricsPlayBtn').textContent=state.playing?'â¸':'â–¶';const isFav=tr&&state.favorites.find(f=>f.uid===tr.uid);if($('fullFavBtn'))$('fullFavBtn').style.color=isFav?'#ff6b6b':'var(--text-main)';$('favBtn').style.color=isFav?'#ff6b6b':'var(--text-main)';document.querySelectorAll('.track').forEach(el=>{const uid=state.current?state.current.uid:null;const list=[...state.results,...state.favorites,...state.history];const track=list.find(t=>t.uid===uid);el.classList.toggle('playing',track&&el.querySelector('.playbtn').onclick.toString().includes(track.uid));});document.querySelectorAll('.playbtn').forEach(btn=>{const trackRow=btn.closest('.track');if(trackRow){const isCurrentTrack=state.current&&trackRow.querySelector('.title').textContent===state.current.title;btn.textContent=isCurrentTrack&&state.playing?'â¸':'â–¶';}});$('player').classList.toggle('show',!!tr);}
        function renderLyrics(){
            const wrap=$('lyricsScroll');
            wrap.innerHTML='';
            if(!state.lyrics.length){
                wrap.innerHTML='<div style="margin-top:30px;color:var(--text-sub)">æš‚æ— æ­Œè¯</div>';
                return;
            }
            state.lyrics.forEach((l,i)=>{
                const div=document.createElement('div');
                div.textContent=l.text;
                div.dataset.idx=i;
                div.dataset.time=l.time;
                wrap.appendChild(div);
            });
            state.lyricIndex=-1;
            $('lyricsTitle').textContent=state.current?state.current.title:'--';
            $('lyricsArtist').textContent=state.current?state.current.singer:'--';
        }
        function renderPlaylist(){
            const wrap=$('playlistScroll');
            wrap.innerHTML='';
            const currentTab=document.querySelector('.tab.active').dataset.tab;
            let list=[];
            if(currentTab==='results')list=state.results;
            else if(currentTab==='favorites')list=state.favorites;
            else list=state.history;

            // æ›´æ–°å…¨é€‰æŒ‰é’®æ–‡æœ¬
            const allSelected=list.length>0&&list.every(t=>state.selectedTracks.includes(t.uid));
            if($('selectAllBtn'))$('selectAllBtn').textContent=allSelected?'å–æ¶ˆå…¨é€‰':'å…¨é€‰';

            list.forEach((tr,idx)=>{
                const item=document.createElement('div');
                item.className='playlist-item';
                if(state.batchMode)item.classList.add('batch-mode');
                if(state.current&&state.current.uid===tr.uid)item.classList.add('active');
                const isSelected=state.selectedTracks.includes(tr.uid);
                item.innerHTML=`<input type="checkbox" class="checkbox" ${isSelected?'checked':''}><div class="index">${idx+1}</div><div class="info"><div class="title">${tr.title||'Unknown'}</div><div class="artist">${tr.singer||''}</div></div>`;

                const checkbox=item.querySelector('.checkbox');
                checkbox.onchange=()=>{
                    if(checkbox.checked){
                        if(!state.selectedTracks.includes(tr.uid))state.selectedTracks.push(tr.uid);
                    }else{
                        state.selectedTracks=state.selectedTracks.filter(uid=>uid!==tr.uid);
                    }
                    // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
                    const allSelected=list.length>0&&list.every(t=>state.selectedTracks.includes(t.uid));
                    if($('selectAllBtn'))$('selectAllBtn').textContent=allSelected?'å–æ¶ˆå…¨é€‰':'å…¨é€‰';
                };

                if(!state.batchMode){
                    item.onclick=async(e)=>{if(e.target===checkbox)return;await playTrack(tr);renderPlaylist();};
                }

                wrap.appendChild(item);
            });
        }
        function updateLyrics(time){
            if(!state.lyrics.length)return;
            let idx=state.lyrics.findIndex((l,i)=>{
                const next=state.lyrics[i+1];
                return time>=l.time&&(next?time<next.time:true);
            });
            if(idx<0||idx===state.lyricIndex)return;
            state.lyricIndex=idx;
            document.querySelectorAll('#lyricsScroll div').forEach((el,i)=>{
                el.classList.toggle('active',i===idx);
                // è®¾ç½®æ¸è¿›é€æ˜åº¦
                const distance = Math.abs(i - idx);
                const opacity = Math.max(0.2, 1 - (Math.floor(distance / 2) * 0.1));
                el.style.opacity = opacity;
            });
            const active=$('lyricsScroll').querySelector('.active');
            if(active)active.scrollIntoView({block:'center',behavior:'smooth'});

            // åŒæ—¶æ›´æ–°å†…è”æ­Œè¯
            updateInlineLyrics(time);
        }

        function renderInlineLyrics(){
            const wrap=$('inlineLyrics');
            const container=document.querySelector('.lyrics-container');
            if(!wrap || !container) return;

            // åªåœ¨PCç«¯æ˜¾ç¤ºæ­Œè¯å®¹å™¨
            if(window.innerWidth >= 768 && state.lyrics.length > 0) {
                container.style.display = 'block';
                wrap.innerHTML = '';
                state.lyrics.forEach((l,i)=>{
                    const div=document.createElement('div');
                    div.textContent=l.text;
                    div.dataset.idx=i;
                    div.dataset.time=l.time;
                    wrap.appendChild(div);
                });
            } else {
                container.style.display = 'none';
            }
        }

        function updateInlineLyrics(time){
            if(!state.lyrics.length||!$('inlineLyrics')||window.innerWidth < 768)return;
            let idx=state.lyrics.findIndex((l,i)=>{
                const next=state.lyrics[i+1];
                return time>=l.time&&(next?time<next.time:true);
            });
            if(idx<0)return;
            document.querySelectorAll('#inlineLyrics div').forEach((el,i)=>{
                el.classList.toggle('active',i===idx);
                // è®¾ç½®æ¸è¿›é€æ˜åº¦
                const distance = Math.abs(i - idx);
                const opacity = Math.max(0.2, 1 - (Math.floor(distance / 2) * 0.1));
                el.style.opacity = opacity;
            });
            const active=$('inlineLyrics').querySelector('.active');
            if(active)active.scrollIntoView({block:'center',behavior:'smooth'});
        }
        function updateVolumeDisplay(){
            const vol=Math.round(dom.audio.volume*100);
            $('volumeValue').textContent=vol;
        }

        function toggleFav(){if(!state.current)return;const idx=state.favorites.findIndex(t=>t.uid===state.current.uid);if(idx>=0){state.favorites.splice(idx,1);toast('å·²å–æ¶ˆæ”¶è—');}else{state.favorites.push(state.current);toast('å·²æ”¶è—');}saveData();updateUI();renderList();}
        function nextTrack(dir){const tab=document.querySelector('.tab.active').dataset.tab;let list=[];if(tab==='results')list=state.results;else if(tab==='favorites')list=state.favorites;else if(tab==='playlists')list=state.history;if(!list.length)return;let idx=list.findIndex(t=>t.uid===state.current.uid);if(idx<0)idx=0;if(state.mode==='single'){$('audio').currentTime=0;$('audio').play();return;}if(state.mode==='shuffle'){if(list.length===1)idx=0;else{let n;do{n=Math.floor(Math.random()*list.length);}while(n===idx);idx=n;}}else{idx=(idx+(dir==='prev'?-1:1)+list.length)%list.length;}playTrack(list[idx]);}

        function togglePlayMode(){
            const modes=['list','single','shuffle'];
            const idx=modes.indexOf(state.mode);
            state.mode=modes[(idx+1)%modes.length];
            saveData();
            updateModeUI();
            const modeNames={list:'åˆ—è¡¨æ’­æ”¾',single:'å•æ›²å¾ªç¯',shuffle:'éšæœºæ’­æ”¾'};
            toast(modeNames[state.mode]);
        }
        function updateModeUI(){
            const icons={list:'ğŸ”',single:'ğŸ”‚',shuffle:'ğŸ”€'};
            if($('fullModeBtn'))$('fullModeBtn').textContent=icons[state.mode];
            updatePlaylistModeUI();
        }
        function updatePlaylistModeUI(){
            const modeBtn=$('playlistModeBtn');
            if(modeBtn){
                if(state.mode==='list')modeBtn.textContent='ğŸ”';
                else if(state.mode==='loop')modeBtn.textContent='ğŸ”‚';
                else if(state.mode==='single')modeBtn.textContent='ğŸ”‚';
            }
        }
        async function downloadTrack(track){
            await ensureDetail(track);
            if(!track.url){toast('æ— æ³•è·å–ä¸‹è½½é“¾æ¥');return;}
            try{
                const response=await fetch(track.url);
                const blob=await response.blob();
                const url=window.URL.createObjectURL(blob);
                const a=document.createElement('a');
                a.href=url;
                a.download=`${track.title}-${track.singer}.mp3`;
                a.target='_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                toast(`${track.title} å¼€å§‹ä¸‹è½½`);
            }catch(e){
                window.open(track.url,'_blank');
                toast(`${track.title} å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ä¸‹è½½é“¾æ¥`);
            }
        }
        async function batchDownload(){
            if(!state.selectedTracks.length){toast('è¯·é€‰æ‹©è¦ä¸‹è½½çš„æ­Œæ›²');return;}
            const currentTab=document.querySelector('.tab.active').dataset.tab;
            let list=[];
            if(currentTab==='results')list=state.results;
            else if(currentTab==='favorites')list=state.favorites;
            else list=state.history;

            const selectedList=list.filter(t=>state.selectedTracks.includes(t.uid));
            toast(`å¼€å§‹æ‰¹é‡ä¸‹è½½ ${selectedList.length} é¦–æ­Œæ›²`);

            for(const track of selectedList){
                await downloadTrack(track);
                await new Promise(resolve=>setTimeout(resolve,1000));
            }
        }

        function setup(){
            dom.audio=$('audio');dom.searchInput=$('searchInput');dom.playPauseBtn=$('playPauseBtn');dom.nextBtn=$('nextBtn');dom.progressBar=$('progressBar');dom.progressWrapper=$('progressWrapper');dom.progressHandle=$('progressHandle');dom.menuBtn=$('menuBtn');dom.fullPlayerMask=$('fullPlayerMask');dom.fullPlayerPanel=$('fullPlayerPanel');dom.fullPlayerClose=$('fullPlayerClose');dom.fullCover=$('fullCover');dom.fullPlayBtn=$('fullPlayBtn');dom.fullPrevBtn=$('fullPrevBtn');dom.fullNextBtn=$('fullNextBtn');dom.fullFavBtn=$('fullFavBtn');dom.fullModeBtn=$('fullModeBtn');dom.fullDownloadBtn=$('fullDownloadBtn');dom.fullLyricsBtn=$('fullLyricsBtn');dom.fullVolumeBtn=$('fullVolumeBtn');dom.fullProgressWrapper=$('fullProgressWrapper');dom.fullProgressBar=$('fullProgressBar');dom.fullProgressHandle=$('fullProgressHandle');dom.favBtn=$('favBtn');dom.fullListBtn=$('fullListBtn');

            dom.searchInput.addEventListener('keydown',e=>{if(e.key==='Enter'){state.keyword=dom.searchInput.value.trim();searchAll(true);$('searchHistory').classList.remove('show');}});
            $('searchIcon').addEventListener('click',()=>{state.keyword=dom.searchInput.value.trim();searchAll(true);$('searchHistory').classList.remove('show');});
            dom.searchInput.addEventListener('focus',()=>{if(state.searchHistory.length)renderSearchHistory();});
            dom.searchInput.addEventListener('blur',()=>{setTimeout(()=>$('searchHistory').classList.remove('show'),200);});
            $('disclaimerBtn').addEventListener('click',()=>{$('disclaimerModal').style.display='flex';});
            $('disclaimerClose').addEventListener('click',()=>{$('disclaimerModal').style.display='none';});
            $('disclaimerModal').addEventListener('click',e=>{if(e.target===$('disclaimerModal'))$('disclaimerModal').style.display='none';});
            document.querySelectorAll('.sourcebar input').forEach(cb=>cb.addEventListener('change',()=>{state.enabledSources[cb.dataset.src]=cb.checked;saveData();}));
            $('limitSelect').addEventListener('change',()=>{state.perLimit=parseInt($('limitSelect').value);saveData();toast(`ç»“æœæ•°é‡å·²è®¾ç½®ä¸º${state.perLimit}æ¡`);if(state.keyword){searchAll(true);}else{loadDefault();}});
            $('qualitySelect').addEventListener('change',()=>{state.quality=$('qualitySelect').value;saveData();toast(`éŸ³è´¨å·²åˆ‡æ¢è‡³${state.quality==='lossless'?'æ— æŸ':state.quality==='high'?'é«˜å“è´¨':'æ ‡å‡†'}`);if(state.keyword){searchAll(true);}else{loadDefault();}});
            document.querySelectorAll('.tab').forEach(tab=>tab.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t===tab));renderList();}));

            dom.playPauseBtn.addEventListener('click',async(e)=>{if(!state.current)return;if(state.current.url){if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();}else{await playTrack(state.current,e.target);}});
            dom.nextBtn.addEventListener('click',()=>nextTrack('next'));
            dom.favBtn.addEventListener('click',toggleFav);
            dom.menuBtn.addEventListener('click',()=>{dom.fullPlayerMask.classList.add('show');dom.fullPlayerPanel.classList.add('show');});

            // å…¨å±æ’­æ”¾å™¨äº‹ä»¶
            dom.fullPlayBtn.addEventListener('click',async(e)=>{if(!state.current)return;if(state.current.url){if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();}else{await playTrack(state.current,e.target);}});
            dom.fullPrevBtn.addEventListener('click',()=>nextTrack('prev'));
            dom.fullNextBtn.addEventListener('click',()=>nextTrack('next'));
            dom.fullFavBtn.addEventListener('click',toggleFav);
            dom.fullModeBtn.addEventListener('click',togglePlayMode);
            dom.fullDownloadBtn.addEventListener('click',()=>downloadTrack(state.current));
            $('fullLyricsBtn').addEventListener('click',()=>{
                if(window.innerWidth >= 768) {
                    // PCç«¯ä¸åšä»»ä½•æ“ä½œï¼Œå› ä¸ºæ­Œè¯å·²ç»æ˜¾ç¤ºåœ¨æ—è¾¹
                    return;
                } else {
                    // æ‰‹æœºç«¯æ˜¾ç¤ºæ­Œè¯é¡µé¢
                    showLyrics();
                }
            });
            $('fullPlayerOpacitySlider').addEventListener('input',()=>{const opacity=parseFloat($('fullPlayerOpacitySlider').value);$('fullPlayerPanel').style.background=`linear-gradient(135deg,rgba(26,26,46,${opacity}),rgba(26,31,58,${opacity}))`;});
            $('playlistOpacitySlider').addEventListener('input',()=>{const opacity=parseFloat($('playlistOpacitySlider').value);$('playlistView').style.background=`rgba(26,26,46,${opacity})`;});
            dom.fullListBtn.addEventListener('click',()=>{renderPlaylist();$('playlistView').style.display='flex';$('fullPlayerOpacitySlider').parentElement.style.display='none';});
            $('playlistBackBtn').addEventListener('click',()=>{$('playlistView').style.display='none';$('fullPlayerOpacitySlider').parentElement.style.display='flex';});
            $('playlistModeBtn').addEventListener('click',()=>{
                if(state.mode==='list')state.mode='loop';
                else if(state.mode==='loop')state.mode='single';
                else state.mode='list';
                updatePlaylistModeUI();
                saveData();
                toast(state.mode==='list'?'é¡ºåºæ’­æ”¾':state.mode==='loop'?'å¾ªç¯æ’­æ”¾':'å•æ›²å¾ªç¯');
            });
            $('batchModeBtn').addEventListener('click',()=>{
                state.batchMode=!state.batchMode;
                state.selectedTracks=[];
                renderPlaylist();
                document.querySelector('.playlist-batch-controls').classList.toggle('show',state.batchMode);
            });
            $('selectAllBtn').addEventListener('click',()=>{
                const currentTab=document.querySelector('.tab.active').dataset.tab;
                let list=[];
                if(currentTab==='results')list=state.results;
                else if(currentTab==='favorites')list=state.favorites;
                else list=state.history;

                const allSelected=list.length>0&&list.every(t=>state.selectedTracks.includes(t.uid));
                if(allSelected){
                    state.selectedTracks=[];
                    $('selectAllBtn').textContent='å…¨é€‰';
                }else{
                    state.selectedTracks=list.map(t=>t.uid);
                    $('selectAllBtn').textContent='å–æ¶ˆå…¨é€‰';
                }
                renderPlaylist();
            });
            $('batchDownloadBtn').addEventListener('click',batchDownload);
            $('cancelBatchBtn').addEventListener('click',()=>{
                state.batchMode=false;
                state.selectedTracks=[];
                renderPlaylist();
                document.querySelector('.playlist-batch-controls').classList.remove('show');
            });

            $('fullMuteBtn').addEventListener('click',()=>{state.muted=!state.muted;dom.audio.muted=state.muted;$('fullMuteBtn').textContent=state.muted?'ğŸ”‡':'ğŸ”Š';toast(state.muted?'å·²é™éŸ³':'å·²å–æ¶ˆé™éŸ³');});
            dom.fullProgressWrapper.addEventListener('click',e=>{if(!fullProgressDragging){const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=(e.clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));}});

            // æ­Œè¯å’ŒéŸ³é‡é¢æ¿
            $('lyricsBackBtn').addEventListener('click', hideLyrics);

            // æ­Œè¯ç•Œé¢å³æ»‘è¿”å›ï¼ˆè§¦æ‘¸å’Œé¼ æ ‡ï¼‰
            let lyricsStartX = 0;
            let lyricsMouseStartX = 0;
            let lyricsIsDragging = false;

            $('lyricsView').addEventListener('touchstart', e => {
                lyricsStartX = e.touches[0].clientX;
            });
            $('lyricsView').addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchEndX - lyricsStartX;
                if (diff > 50) { // å³æ»‘è¶…è¿‡50px
                    hideLyrics();
                }
            });

            $('lyricsView').addEventListener('mousedown', e => {
                lyricsMouseStartX = e.clientX;
                lyricsIsDragging = true;
            });
            $('lyricsView').addEventListener('mouseup', e => {
                if (lyricsIsDragging) {
                    const diff = e.clientX - lyricsMouseStartX;
                    if (diff > 50) { // å³æ»‘è¶…è¿‡50px
                        hideLyrics();
                    }
                    lyricsIsDragging = false;
                }
            });
            $('lyricsView').addEventListener('mouseleave', () => {
                lyricsIsDragging = false;
            });
            $('volumeBackBtn').addEventListener('click',()=>{$('volumePanel').style.display='none';});
            document.querySelectorAll('.volume-preset').forEach(btn=>btn.addEventListener('click',()=>{const vol=parseFloat(btn.dataset.volume);dom.audio.volume=vol;state.volume=vol;saveData();}));
            $('jumpPrev').onclick=()=>{if(state.lyricIndex>0){dom.audio.currentTime=state.lyrics[state.lyricIndex-1].time+.1;}};
            $('jumpNext').onclick=()=>{if(state.lyricIndex<state.lyrics.length-1){dom.audio.currentTime=state.lyrics[state.lyricIndex+1].time+.1;}};
            $('lyricsStyleBtn').onclick=()=>{state.lyricsAlt=!state.lyricsAlt;$('lyricsScroll').classList.toggle('alt-style',state.lyricsAlt);toast('æ­Œè¯æ ·å¼å·²åˆ‡æ¢');};

            // è¿›åº¦æ¡æ‹–åŠ¨åŠŸèƒ½ï¼ˆé¼ æ ‡å’Œè§¦æ‘¸ï¼‰
            let progressDragging = false;
            let fullProgressDragging = false;

            // åº•éƒ¨è¿›åº¦æ¡
            dom.progressWrapper.addEventListener('mousedown',e=>{progressDragging=true;const rect=dom.progressWrapper.getBoundingClientRect();const r=(e.clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});
            dom.progressWrapper.addEventListener('touchstart',e=>{progressDragging=true;const rect=dom.progressWrapper.getBoundingClientRect();const r=(e.touches[0].clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});

            document.addEventListener('mousemove',e=>{if(progressDragging){const rect=dom.progressWrapper.getBoundingClientRect();const r=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));const dur=dom.audio.duration||0;dom.audio.currentTime=dur*r;}});
            document.addEventListener('touchmove',e=>{if(progressDragging){const rect=dom.progressWrapper.getBoundingClientRect();const r=Math.max(0,Math.min(1,(e.touches[0].clientX-rect.left)/rect.width));const dur=dom.audio.duration||0;dom.audio.currentTime=dur*r;}});

            document.addEventListener('mouseup',()=>{progressDragging=false;});
            document.addEventListener('touchend',()=>{progressDragging=false;});

            // å…¨å±è¿›åº¦æ¡
            dom.fullProgressWrapper.addEventListener('mousedown',e=>{fullProgressDragging=true;const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=(e.clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});
            dom.fullProgressWrapper.addEventListener('touchstart',e=>{fullProgressDragging=true;const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=(e.touches[0].clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});

            document.addEventListener('mousemove',e=>{if(fullProgressDragging){const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));const dur=dom.audio.duration||0;dom.audio.currentTime=dur*r;}});
            document.addEventListener('touchmove',e=>{if(fullProgressDragging){const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=Math.max(0,Math.min(1,(e.touches[0].clientX-rect.left)/rect.width));const dur=dom.audio.duration||0;dom.audio.currentTime=dur*r;}});

            document.addEventListener('mouseup',()=>{fullProgressDragging=false;});
            document.addEventListener('touchend',()=>{fullProgressDragging=false;});
            dom.audio.addEventListener('timeupdate',()=>{const cur=dom.audio.currentTime||0;const dur=dom.audio.duration||0;const r=dur?cur/dur:0;dom.progressBar.style.transform='scaleX('+r+')';const w=dom.progressWrapper.clientWidth;dom.progressHandle.style.left=(w*r)+'px';if(dom.fullProgressBar){dom.fullProgressBar.style.transform='scaleX('+r+')';const fw=dom.fullProgressWrapper.clientWidth;dom.fullProgressHandle.style.left=(fw*r)+'px';}if($('currentTime'))$('currentTime').textContent=fmt(cur);if($('totalTime'))$('totalTime').textContent=fmt(dur);updateLyrics(cur);});
            dom.audio.addEventListener('ended',()=>nextTrack('next'));dom.audio.addEventListener('play',()=>{state.playing=true;updateUI();if(dom.fullCover)dom.fullCover.classList.remove('paused');});dom.audio.addEventListener('pause',()=>{state.playing=false;updateUI();if(dom.fullCover)dom.fullCover.classList.add('paused');});

            document.querySelectorAll('.controls button').forEach(btn=>btn.addEventListener('click',e=>e.stopPropagation()));
            document.querySelector('.cover-wrapper').addEventListener('click',e=>e.stopPropagation());
            document.querySelector('.player').addEventListener('click',()=>{
                if(!state.current)return;
                dom.fullPlayerMask.classList.add('show');
                dom.fullPlayerPanel.classList.add('show');
            });

            dom.fullPlayerClose.addEventListener('click',closeFullPlayer);
            dom.fullPlayerMask.addEventListener('click',closeFullPlayer);

            // å·¦æ»‘æ‰‹åŠ¿æ˜¾ç¤ºæ­Œè¯ï¼ˆè§¦æ‘¸å’Œé¼ æ ‡ï¼‰
            let touchStartX = 0;
            let mouseStartX = 0;
            let isDragging = false;

            function showLyrics() {
                $('lyricsView').style.display = 'flex';
                $('fullPlayerOpacitySlider').parentElement.style.display = 'none';
                setTimeout(() => $('lyricsView').classList.add('show'), 10);
            }

            function hideLyrics() {
                $('lyricsView').classList.remove('show');
                $('fullPlayerOpacitySlider').parentElement.style.display = 'flex';
                setTimeout(() => $('lyricsView').style.display = 'none', 300);
            }

            // è§¦æ‘¸äº‹ä»¶ï¼ˆä»…é™å°é¢åŒºåŸŸï¼‰
            const coverArea = document.querySelector('.full-player-cover');
            if(coverArea) {
                coverArea.addEventListener('touchstart', e => {
                    touchStartX = e.touches[0].clientX;
                });
                coverArea.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].clientX;
                    const diff = touchStartX - touchEndX;
                    if (diff > 50 && window.innerWidth < 768) { // å·¦æ»‘è¶…è¿‡50pxä¸”ä»…é™æ‰‹æœºç«¯
                        showLyrics();
                    }
                });
            }

            // é¼ æ ‡äº‹ä»¶ï¼ˆä»…é™å°é¢åŒºåŸŸï¼‰
            if(coverArea) {
                coverArea.addEventListener('mousedown', e => {
                    mouseStartX = e.clientX;
                    isDragging = true;
                });
                coverArea.addEventListener('mouseup', e => {
                    if (isDragging && window.innerWidth < 768) {
                        const diff = mouseStartX - e.clientX;
                        if (diff > 50) { // å·¦æ»‘è¶…è¿‡50pxä¸”ä»…é™æ‰‹æœºç«¯
                            showLyrics();
                        }
                        isDragging = false;
                    }
                });
                coverArea.addEventListener('mouseleave', () => {
                    isDragging = false;
                });
            }

            // æ­Œè¯ç•Œé¢æ’­æ”¾æŒ‰é’®
            $('lyricsPlayBtn').addEventListener('click', async(e) => {
                if (!state.current) return;
                if(state.current.url){
                    if (dom.audio.paused) {
                        dom.audio.play();
                        state.playing = true;
                    } else {
                        dom.audio.pause();
                        state.playing = false;
                    }
                    updateUI();
                    $('lyricsPlayBtn').textContent = state.playing ? 'â¸' : 'â–¶';
                }else{
                    await playTrack(state.current,e.target);
                }
            });
            function closeFullPlayer(){
                dom.fullPlayerMask.classList.remove('show');
                dom.fullPlayerPanel.classList.remove('show');
                hideLyrics();
                $('volumePanel').style.display='none';
                $('playlistView').style.display='none';
                $('fullPlayerOpacitySlider').parentElement.style.display='flex';
            }

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown',e=>{
                const tag=document.activeElement.tagName.toLowerCase();
                const typing=(tag==='input'||tag==='textarea');
                if(e.code==='Space'&&!typing){e.preventDefault();if(dom.playPauseBtn)dom.playPauseBtn.click();}
                if(e.key==='ArrowRight'&&!typing){dom.audio.currentTime=(dom.audio.currentTime||0)+5;}
                if(e.key==='ArrowLeft'&&!typing){dom.audio.currentTime=Math.max(0,(dom.audio.currentTime||0)-5);}
                if(e.key==='ArrowUp'&&!typing){dom.audio.volume=Math.min(1,(dom.audio.volume||0)+0.05);if($('volumeSlider'))$('volumeSlider').value=dom.audio.volume;updateVolumeDisplay();}
                if(e.key==='ArrowDown'&&!typing){dom.audio.volume=Math.max(0,(dom.audio.volume||0)-0.05);if($('volumeSlider'))$('volumeSlider').value=dom.audio.volume;updateVolumeDisplay();}
                if((e.key==='n'||e.key==='N')&&!typing)nextTrack('next');
                if((e.key==='p'||e.key==='P')&&!typing)nextTrack('prev');
                if((e.key==='f'||e.key==='F')&&!typing)toggleFav();
                if((e.key==='m'||e.key==='M')&&!typing){state.muted=!state.muted;dom.audio.muted=state.muted;toast(state.muted?'å·²é™éŸ³':'å·²å–æ¶ˆé™éŸ³');}
                if((e.key==='d'||e.key==='D')&&!typing)downloadTrack(state.current);
                if(e.key==='/'&&!typing){e.preventDefault();dom.searchInput.focus();dom.searchInput.select();}
            });

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', () => {
                renderInlineLyrics();
            });

            // æ­Œè¯åŒºåŸŸé¼ æ ‡æ»šåŠ¨æ”¯æŒ
            const lyricsContainer = document.querySelector('.lyrics-container');
            if(lyricsContainer) {
                lyricsContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    lyricsContainer.scrollTop += e.deltaY;
                });
            }

            // åˆå§‹åŒ–
            loadData();
            Object.keys(state.enabledSources).forEach(src=>{
                const cb=document.querySelector(`[data-src="${src}"]`);
                if(cb)cb.checked=state.enabledSources[src];
            });
            $('limitSelect').value=state.perLimit;
            $('qualitySelect').value=state.quality;
            dom.audio.volume=state.volume;
            $('fullMuteBtn').textContent=state.muted?'ğŸ”‡':'ğŸ”Š';
            updateModeUI();

            loadDefault();
        }
        document.addEventListener('DOMContentLoaded',setup);
    })();
</script>
</body>
</html>
